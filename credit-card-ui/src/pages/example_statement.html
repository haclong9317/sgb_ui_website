<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Giao Dịch</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div id="container">
    <div id="nav-placeholder"></div>
    <button id="toggle-nav-placeholder" class="arrow-btn" style="margin-top: 10px;" onclick="toggleNavigation();">&#9664;</button>
    <main display="flex">
      <div class="modal"  > 
        <div class="forms-wrapper">
        <div class="form-column">
          <div class="forms-wrapper">
            <div class="form-column" style="flex: 0.3;">
              <h2>Form Giao Dịch</h2>
          <form id="transaction-form" action="javascript:void(0);" method="POST">
            <!-- Loại giao dịch -->
            <div class="form-group">
              <label for="transaction-type">Loại giao dịch:</label>
              <select id="transaction-type" name="transaction-type" required>
                <option value="" disabled selected>Chọn loại giao dịch</option>
                <option value="sale">Sale</option>
                <option value="cash">Cash</option>
                <option value="refund">Refund</option>
                <!-- <option value="refund">Void</option> -->
              </select>
            </div>
    
            <!-- Số tiền -->
            <div class="form-group">
              <label for="amount">Số tiền:</label>
              <input type="number" id="amount" name="amount" placeholder="Nhập số tiền" required>
            </div>
    
            <!-- Combobox hiển thị các giao dịch Sale -->
            <div class="form-group">
              <label for="sale-transaction-id">Chọn ID Giao Dịch (Sale):</label>
              <select id="sale-transaction-id" name="sale-transaction-id">
                <option value="" disabled selected>Chọn ID Giao Dịch Sale</option>
              </select>
            </div>
    
            <!-- Nút Submit -->
            <div class="form-group">
              <button type="submit" class="edit-btn">Tạo giao dịch</button>
            </div>
    
          </form>  
            </div>
            <div class="form-column">
              <h2>Log</h2>
              <div id="log-container" style="border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; background-color: #f9f9f9;">
                <!-- Log sẽ được ghi ra đây -->
              </div>
            </div>
          </div>
          <!-- Bảng hiển thị giao dịch -->
          <h2>Danh sách giao dịch</h2>
          <label id="payment-remaining-label" style="font-weight: bold;">Số tiền thanh toán còn lại trong kỳ: Chưa xác định</label>
          <div style="margin-top: 20px;margin-bottom: 20px;">
            <button id="create-sample-btn" class="edit-btn" style="background-color: blue; color: white;">Tạo Giao Dịch Mẫu (n)</button>
            <button id="reset-sample-btn" class="edit-btn" style="background-color: red ; color: white;">Reset table</button>
            <button id="create-txn-sample-btn" class="edit-btn" style="background-color: green ; color: white;">Tạo Giao Dịch Mẫu</button>
            <button id="create-txn-sale-sample-btn" class="edit-btn" style="background-color: darkorange; color: white;">Tạo Giao Dịch Mẫu Sale</button>
            <button id="create-txn-cash-sample-btn" class="edit-btn" style="background-color: gold; color: white;">Tạo Giao Dịch Mẫu Cash</button>
            <button id="create-txn-payment-sample-btn" class="edit-btn" style="background-color: green; color: white;">Tạo Giao Dịch Mẫu Payment</button>
            <button id="create-txn-void-sample-btn" class="edit-btn" style="background-color: teal; color: white;">Tạo Giao Dịch Mẫu Void</button>
          </div>
          <div style="margin-top: 20px;margin-bottom: 20px;">
            <button id="add-Delimeter-btn" class="edit-btn" style="background-color: blue; color: white;">Thêm delimeter</button>
            <button id="reset-log-btn" class="edit-btn" style="background-color: red; color: white;">Reset Log</button>
          </div>
          <table id="transaction-table" border="1" style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead>
              <tr>
                <th>ID</th>
                <th>ID G.D Gốc</th>
                <th>Loại Giao Dịch</th>
                <th>Trạng Thái</th> <!-- Cột Trạng Thái -->
                <th>Số Tiền gốc</th>
                <th>Số Tiền cập nhật</th>
                <th>Ngày</th>
                <th>Ngày void</th>
                <th>Ngày refund</th>
                <th>Ngày post</th> <!-- Thêm cột Ngày Post -->
                <th>Ngày paid</th> <!-- Thêm cột Ngày Paid -->
                <th>T.T sao kê</th> <!-- Thêm cột trạng thái statement -->
                <th>Ngày t.toán cuối</th> <!-- Thêm cột ngày thanh toán cuối -->
                <th>Hành Động</th>
              </tr>
            </thead>
            <tbody>
              <!-- Các giao dịch sẽ được thêm vào đây -->
            </tbody>
          </table>
          <div style="margin-top: 20px;">
            <button id="save-table-btn" class="edit-btn">Lưu tạm</button>
            <button id="save-table-btn1" class="edit-btn">Lưu vào file</button>
            <button id="cal-statement" class="edit-btn" >Tính sao kê</button>
            <!-- <div style="margin-top: 20px;">
              <button id="create-sample-btn" class="edit-btn" style="background-color: blue; color: white;">Tạo Giao Dịch Mẫu</button>
              <button id="reset-sample-btn" class="edit-btn" style="background-color: blue; color: white;">Reset table</button>
            </div>
            <div style="margin-top: 20px;">
              <button id="reset-sample-btn" class="edit-btn" style="background-color: blue; color: white;">Reset table</button>
            </div> -->
            <div style="margin-top: 20px;">
              <button id="reset-localstorage-btn" class="edit-btn" style="background-color: red; color: white;">Reset Local Storage</button>
            </div>
            <div style="margin-top: 20px;">
              <label for="upload-file" style="margin-right: 10px;">Tải file JSON:</label>
              <input type="file" id="upload-file" accept=".json">
            </div>
          </div>
        </div>
        <div class="form-column">
          <h2>Thông tin sao kê</h2>
        <table id="summary-table" border="1" style="width: 100%; border-collapse: collapse; text-align: left;">
          <thead>
            <tr>
              <th>Trạng Thái</th>
              <th>Tổng Số Tiền</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>New</td>
              <td id="sum-new">0</td>
            </tr>
            <tr>
              <td>Voided</td>
              <td id="sum-voided">0</td>
            </tr>
            <tr>
              <td>Refunded</td>
              <td id="sum-refunded">0</td>
            </tr>
            <tr>
              <td>Cash</td>
              <td id="sum-cash">0</td>
            </tr>
            <tr>
              <td>Payment</td>
              <td id="sum-payment">0</td>
            </tr>
            <tr>
              <td>Fee</td>
              <td id="sum-fee">0</td>
            </tr>
          </tbody>
        </table>
        <br>
        <h2>Chi Tiết Tính Lãi</h2>
        <br>
        <label id="statement-date-label" style="font-weight: bold;">Ngày sao kê: Chưa xác định</label>
        <br>
        <table id="interest-table-old" border="1" style="width: 100%; border-collapse: collapse; text-align: left;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Loại Bucket</th>
              <th>Số Tiền Gốc</th>
              <th>Số Ngày Tính Lãi</th>
              <th>Từ ngày</th>
              <th>Đến ngày</th>
              <th>Tiền Lãi</th>
            </tr>
          </thead>
          <tbody>
            <!-- Các giao dịch sẽ được thêm vào đây -->
          </tbody>
        </table>
        <br>
        <table id="interest-table" border="1" style="width: 100%; border-collapse: collapse; text-align: left;">
          <thead>
            <tr>
              <th>ID Giao Dịch</th>
              <th>Loại Giao Dịch</th>
              <th>Số Tiền Gốc</th>
              <th>Số Ngày Tính Lãi</th>
              <th>Từ ngày</th>
              <th>Đến ngày</th>
              <th>Tiền Lãi</th>
            </tr>
          </thead>
          <tbody>
            <!-- Các giao dịch sẽ được thêm vào đây -->
          </tbody>
        </table>
        <br>
        <label id="statement-opening-debt-sale-label" style="font-weight: bold;">Dư nợ đầu kỳ : Chưa xác định</label>
        <label id="bucket-status" style="font-weight: bold;">Tình trạng: Chưa xác định</label>
        <label id="statement-original-amount-sale-label" style="font-weight: bold;">Số tiền sale trong kỳ: Chưa xác định</label>
        <label id="statement-original-amount-cash-label" style="font-weight: bold;">Số tiền cash trong kỳ: Chưa xác định</label>
        <label id="statement-original-amount-fee-label" style="font-weight: bold;">Số tiền fee trong kỳ: Chưa xác định</label>
        <label id="statement-original-amount-payment-label" style="font-weight: bold;">Số tiền payment trong kỳ: Chưa xác định</label>
        ------------------------------------------------------------------------------
        <label id="statement-original-amount-label" style="font-weight: bold;">Tổng tiền gốc trong kỳ: Chưa xác định</label>
        <label id="statement-interest-label" style="font-weight: bold;">Số tiền lãi trong kỳ: Chưa xác định</label>
        <label id="statement-min-amount-label" style="font-weight: bold;">Số tiền tối thiểu phải trả: Chưa xác định</label>
        <br>
        <h2>Danh Sách Bucket</h2>
        <br>
        <table id="bucket-list-table" border="1" style="width: 100%; border-collapse: collapse; text-align: left;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Mô tả</th>
              <th>Số tiền tối thiểu</th>
              <th>Số tiền thanh toán</th>
              <th>Ngày thanh toán</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody>
            <!-- Các giao dịch sẽ được thêm vào đây -->
          </tbody>
        </table>
        <br>
        </div>    
      </div>
      </div>
      <div class="modal">
        
      </div>  
    </main>
  </div>
  <script>
    // Biến để theo dõi ID và ngày
    let transactionIdCounter = 0;
    let dayCounter = 0;
    let lastIndex = 0; // Biến lưu trữ index cuối cùng trong mảng transactions
    let cycle = 0; // Biến để theo dõi chu kỳ sao kê
    let buttonClickedCnt = 0; // Biến để theo dõi số lần nút "Tạo Giao Dịch Mẫu" được nhấn
    let amountPaymentInCycle = 0; // Biến để theo dõi tổng số tiền thanh toán trong chu kỳ
    let calInterestForSale = false; // Biến để theo dõi có phải tính lãi cho giao dịch Sale hay không
    let calInterestForFee = false; // Biến để theo dõi có phải tính lãi cho giao dịch Sale hay không
    let payAction = 0; // Biến để theo dõi hành động thanh toán (0: không có, 1: thanh toán full, 2: thanh toán min, 3: thanh toán 1 phần lớn hơn min payment, 4: thanh toán 1 phần không lớn hơn min payment, 4: không thanh toán)
    let paymentForStatement = 0; // Biến để theo dõi số tiền thanh toán trong kỳ sao kê
    let bucketInterest = 0; // Biến để lưu trữ số tiền lãi khi kết thúc cycle
    

    document.getElementById('transaction-form').addEventListener('submit', function (event) {
      event.preventDefault(); // Ngăn chặn reload trang

      // Lấy giá trị từ form
      const transactionType = document.getElementById('transaction-type').value;
      const amount = document.getElementById('amount').value;
      const saleTransactionId = document.getElementById('sale-transaction-id').value;

      // Kiểm tra nếu các giá trị không hợp lệ
      if (!transactionType || !amount) {
        alert("Vui lòng nhập đầy đủ thông tin!");
        return;
      }

      // Nếu loại giao dịch là refund, kiểm tra xem ID giao dịch gốc đã được chọn chưa
      if (transactionType === "refund" && !saleTransactionId) {
        alert("Vui lòng chọn ID Giao Dịch Gốc (Sale) để thực hiện Refund!");
        return;
      }

      // Tăng ID giao dịch và ngày
      transactionIdCounter++;
      dayCounter++;
      const transactionId = `T${transactionIdCounter}`;
      const originalTransactionId = transactionType === "refund" ? saleTransactionId : ""; // Giao dịch gốc chỉ áp dụng cho Refund
      const day = `T + ${dayCounter - 1}`;
      const status = "new"; // Trạng thái mặc định là new

      // Tạo một hàng mới trong bảng
      const tableBody = document.querySelector('#transaction-table tbody');
      const newRow = document.createElement('tr');
      newRow.id = `row-${transactionIdCounter}`; // Gán ID duy nhất cho hàng
      newRow.innerHTML = `
        <td>${transactionId}</td>
        <td>${originalTransactionId}</td>
        <td>${transactionType}</td>
        <td>${status}</td> <!-- Trạng thái -->
        <td>${amount}</td>
        <td>${0}</td> <!-- Số tiền cập nhật -->
        <td>${day}</td>
        <td>-</td>
        <td>-</td>
        <td>
          ${
            transactionType === "void" || transactionType === "refund" || transactionType === "cash"
              ? "" // Không có nút nếu loại giao dịch là void hoặc refund
              : `
                <button class="edit-btn" onclick="voidTransaction('${transactionId}')">Void</button>
                <button class="edit-btn" onclick="refundTransaction('${transactionId}')">Refund</button>
              `
          }
        </td>
      `;

      // Thêm hàng mới vào bảng
      tableBody.appendChild(newRow);

      // Nếu loại giao dịch là refund, cập nhật trạng thái của giao dịch gốc
      if (transactionType === "refund" && saleTransactionId) {
        const currentRow = document.querySelector(`#row-${saleTransactionId.replace('T', '')}`);
        if (currentRow) {
          // Lấy số tiền gốc và số tiền cập nhật của giao dịch gốc
          const originalAmount = parseInt(currentRow.children[4].textContent) || 0; // Số tiền gốc
          const updatedAmount = parseInt(currentRow.children[5].textContent) || originalAmount; // Số tiền cập nhật (nếu có)

          // Tính số tiền còn lại sau khi refund
          const remainingAmount = updatedAmount - amount;

          // Cập nhật số tiền còn lại vào cột Số Tiền Cập Nhật
          currentRow.children[5].textContent = remainingAmount.toFixed(2);

          // Cập nhật trạng thái của giao dịch gốc
          currentRow.children[3].textContent = "refunded"; // Cập nhật cột Trạng Thái (index 3)
          currentRow.children[8].textContent = day; // Cập nhật cột Ngày refunded (index 8)

          // Disable các nút trong cột Hành Động của giao dịch gốc
          const buttons = currentRow.querySelectorAll('button');
          buttons.forEach(button => {
            button.disabled = true;
            button.style.opacity = 0.5; // Thêm hiệu ứng mờ để hiển thị nút bị disable
            button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
          });
        }
      }

      // Cập nhật combobox giao dịch Sale
      updateSaleTransactionDropdown();

      // Reset form
      document.getElementById('transaction-form').reset();

      // Kiểm tra nếu ngày đạt đến T + 25, T + 50, ...
      if (dayCounter % 25 === 0) {
        statement(day); // Gọi hàm statement
      }
    });

    // Hàm cập nhật combobox với các giao dịch Sale
    function updateSaleTransactionDropdown() {
      const saleDropdown = document.getElementById('sale-transaction-id');
      const tableRows = document.querySelectorAll('#transaction-table tbody tr');

      // Xóa các tùy chọn cũ
      saleDropdown.innerHTML = '<option value="" disabled selected>Chọn ID Giao Dịch Sale</option>';

      // Duyệt qua các hàng trong bảng và thêm các giao dịch Sale có trạng thái "new" vào combobox
      tableRows.forEach(row => {
        const transactionType = row.children[2].textContent; // Cột Loại Giao Dịch
        const status = row.children[3].textContent; // Cột Trạng Thái
        const transactionId = row.children[0].textContent; // Cột ID

        if (transactionType === 'sale' && status === 'new') {
          const option = document.createElement('option');
          option.value = transactionId;
          option.textContent = transactionId;
          saleDropdown.appendChild(option);
        }
      });
    }

    // Hàm xử lý Void
    function voidTransaction(transactionId) {
      // Lấy hàng hiện tại dựa trên transactionId
      const currentRow = document.querySelector(`#row-${transactionId.replace('T', '')}`);
      //alert(currentRow);
      
      // Lấy thông tin từ hàng hiện tại
      const originalTransactionId = `<span class="original-void">${transactionId}</span>`;; // ID Giao Dịch Gốc là transactionId
      //originalTransactionId = `<span class="original-void">${selectedSale.id}</span>`; // Thêm class màu đỏ
      //const originalTransactionId = transactionId; // ID Giao Dịch Gốc là transactionId
      const amount = currentRow.children[4].textContent; // Lấy số tiền từ cột thứ 5 (index 4)
      
      // Tăng ID giao dịch và ngày
      transactionIdCounter++;
      dayCounter++;
      const newTransactionId = `T${transactionIdCounter}`;
      const day = `T + ${dayCounter - 1}`;

      // Tạo một hàng mới trong bảng
      const tableBody = document.querySelector('#transaction-table tbody');
      const newRow = document.createElement('tr');
      newRow.id = `row-${transactionIdCounter}`; // Gán ID duy nhất cho hàng
      newRow.innerHTML = `
        <td>${newTransactionId}</td>
        <td>${originalTransactionId}</td>
        <td>void</td>
        <td>new</td> <!-- Trạng thái là voided -->
        <td>${amount}</td>
        <th>0</th>
        <td>${day}</td>
        <td>-</td>
        <td>-</td>
        <td></td> <!-- Không có nút trong cột Hành Động -->
      `;

      // Thêm hàng mới vào bảng
      tableBody.appendChild(newRow);

      // Cập nhật trạng thái của hàng hiện tại
      currentRow.children[3].textContent = "voided"; // Cập nhật cột Trạng Thái (index 3)
      currentRow.children[7].textContent = day; // Cập nhật cột Ngày voided (index 7)

      // Disable các nút trong cột Hành Động của hàng hiện tại
      const buttons = currentRow.querySelectorAll('button');
      buttons.forEach(button => {
        button.disabled = true;
        button.style.opacity = 0.5; // Thêm hiệu ứng mờ để hiển thị nút bị disable
        button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
      });

      // Cập nhật combobox giao dịch Sale
      updateSaleTransactionDropdown();

      //alert(`Bạn đã chọn Void cho giao dịch ${transactionId}`);
        // Kiểm tra nếu ngày đạt đến T + 25, T + 50, ...
      if (dayCounter % 25 === 0) {
        statement(day); // Gọi hàm statement
      }
    }

    // Hàm xử lý Refund
    function refundTransaction(transactionId) {
      // Lấy hàng hiện tại dựa trên transactionId
      const currentRow = document.querySelector(`#row-${transactionId.replace('T', '')}`);
      
      // Lấy thông tin từ hàng hiện tại
      // const originalTransactionId = transactionId; // ID Giao Dịch Gốc là transactionId
      const originalTransactionId = `<span class="original-refund">${transactionId}</span>`;; // ID Giao Dịch Gốc là transactionId
      const amount = currentRow.children[4].textContent; // Lấy số tiền từ cột thứ 5 (index 4)
      
      // Tăng ID giao dịch và ngày
      transactionIdCounter++;
      dayCounter++;
      const newTransactionId = `T${transactionIdCounter}`;
      const day = `T + ${dayCounter - 1}`;

      // Tạo một hàng mới trong bảng
      const tableBody = document.querySelector('#transaction-table tbody');
      const newRow = document.createElement('tr');
      newRow.id = `row-${transactionIdCounter}`; // Gán ID duy nhất cho hàng
      newRow.innerHTML = `
        <td>${newTransactionId}</td>
        <td>${originalTransactionId}</td>
        <td>refund</td>
        <td>new</td> <!-- Trạng thái là refunded -->
        <td>${amount}</td>
        <th>0</th>
        <td>${day}</td>
        <td>-</td>
        <td>-</td>
        <td></td> <!-- Không có nút trong cột Hành Động -->
      `;

      // Thêm hàng mới vào bảng
      tableBody.appendChild(newRow);

      // Cập nhật trạng thái của hàng hiện tại
      currentRow.children[3].textContent = "refunded"; // Cập nhật cột Trạng Thái (index 3)
      currentRow.children[8].textContent = day; // Cập nhật cột Ngày refunded (index 8)

      // Disable các nút trong cột Hành Động của hàng hiện tại
      const buttons = currentRow.querySelectorAll('button');
      buttons.forEach(button => {
        button.disabled = true;
        button.style.opacity = 0.5; // Thêm hiệu ứng mờ để hiển thị nút bị disable
        button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
      });

      // Cập nhật combobox giao dịch Sale
      updateSaleTransactionDropdown();

      //alert(`Bạn đã chọn Refund cho giao dịch ${transactionId}`);
        // Kiểm tra nếu ngày đạt đến T + 25, T + 50, ...
      if (dayCounter % 25 === 0) {
        statement(day); // Gọi hàm statement
      }
    }

    function saveTableToLocalStorage() {
      const tableRows = document.querySelectorAll('#transaction-table tbody tr');
      const tableData = [];

      // Duyệt qua các hàng trong bảng và lưu dữ liệu
      tableRows.forEach(row => {
        const rowData = {
          id: row.children[0].textContent, // Cột ID
          originalTransactionId: row.children[1].textContent, // Cột ID Giao Dịch Gốc
          transactionType: row.children[2].textContent, // Cột Loại Giao Dịch
          status: row.children[3].textContent, // Cột Trạng Thái
          amount: row.children[4].textContent, // Cột Số Tiền
          amountUpdate: row.children[5].textContent, // Cột Số Tiền updated
          day: row.children[6].textContent, // Cột Ngày
          dayVoided: row.children[7].textContent, // Cột Ngày voided
          dayRefunded: row.children[8].textContent // Cột Ngày refunded
        };
        tableData.push(rowData);
      });

      // Lưu dữ liệu vào Local Storage
      localStorage.setItem('transactionTable', JSON.stringify(tableData));
      alert('Bảng đã được lưu!');
    }

    function saveTableToFile() {
      const tableRows = document.querySelectorAll('#transaction-table tbody tr');
      const tableData = [];

      // Duyệt qua các hàng trong bảng và lưu dữ liệu
      tableRows.forEach(row => {
        const rowData = {
          id: row.children[0].textContent, // Cột ID
          originalTransactionId: row.children[1].textContent, // Cột ID Giao Dịch Gốc
          transactionType: row.children[2].textContent, // Cột Loại Giao Dịch
          status: row.children[3].textContent, // Cột Trạng Thái
          amount: row.children[4].textContent, // Cột Số Tiền
          amountUpdate: row.children[5].textContent, // Cột Số Tiền updated
          day: row.children[6].textContent, // Cột Ngày
          dayVoided: row.children[7].textContent, // Cột Ngày voided
          dayRefunded: row.children[8].textContent // Cột Ngày refunded
        };
        tableData.push(rowData);
      });

      // Tạo file JSON
      const blob = new Blob([JSON.stringify(tableData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      // Tạo link tải file
      const a = document.createElement('a');
      a.href = url;
      a.download = 'transactionTable.json'; // Tên file
      a.click();

      // Giải phóng URL
      URL.revokeObjectURL(url);
    }

    function loadTableFromLocalStorage() {
      const tableBody = document.querySelector('#transaction-table tbody');
      const tableData = JSON.parse(localStorage.getItem('transactionTable'));

      // Nếu không có dữ liệu, thoát
      if (!tableData) return;

      // Xóa nội dung cũ trong bảng
      tableBody.innerHTML = '';

      // Duyệt qua dữ liệu và thêm vào bảng
      tableData.forEach(rowData => {
        const newRow = document.createElement('tr');
        newRow.id = `row-${rowData.id.replace('T', '')}`; // Gán ID duy nhất cho hàng
        newRow.innerHTML = `
          <td>${rowData.id}</td>
          <td>
            ${
              rowData.transactionType === 'void'
                ? `<span class="original-void">${rowData.originalTransactionId}</span>` // Màu đỏ cho void
                : rowData.transactionType === 'refund'
                ? `<span class="original-refund">${rowData.originalTransactionId}</span>` // Màu xanh cho refund
                : rowData.originalTransactionId // Không thay đổi nếu không phải void hoặc refund
            }
          </td>
          <td>${rowData.transactionType}</td>
          <td>${rowData.status}</td>
          <td>${rowData.amount}</td>
          <td>${rowData.amountUpdate}</td>
          <td>${rowData.day}</td>
          <td>${rowData.dayVoided}</td>
          <td>${rowData.dayRefunded}</td>
          <td>
            ${
              rowData.transactionType === 'sale'
                ? `
                  <button class="edit-btn void-btn" onclick="voidTransaction('${rowData.id}')" 
                    ${rowData.status === 'new' ? '' : 'disabled style="opacity: 0.5; cursor: not-allowed;"'}>
                    Void
                  </button>
                  <button class="edit-btn refund-btn" onclick="refundTransaction('${rowData.id}')" 
                    ${rowData.status === 'new' ? '' : 'disabled style="opacity: 0.5; cursor: not-allowed;"'}>
                    Refund
                  </button>
                `
                : ''
            }
          </td>
        `;
        tableBody.appendChild(newRow);
      });

      // Lấy ID cuối cùng trong bảng và cập nhật transactionIdCounter
      const lastRow = tableData[tableData.length - 1];
      if (lastRow) {
        transactionIdCounter = parseInt(lastRow.id.replace('T', ''), 10); // Cập nhật transactionIdCounter

        // Lấy ngày cuối cùng và cập nhật dayCounter
        const lastDay = lastRow.day.replace('T + ', ''); // Lấy số ngày từ chuỗi "T + X"
        dayCounter = parseInt(lastDay, 10) + 1; // Cập nhật dayCounter cho giao dịch tiếp theo
      } else {
        // Nếu không có dữ liệu, bắt đầu từ T + 0
        dayCounter = 0;
      }

      // Cập nhật combobox giao dịch Sale
      updateSaleTransactionDropdown();
    }

    // function loadTableFromFile(event) {
    //   const file = event.target.files[0]; // Lấy file được chọn
    //   if (!file) return;

    //   const reader = new FileReader();
    //   reader.onload = function (e) {
    //     const tableData = JSON.parse(e.target.result); // Parse nội dung file JSON
    //     const tableBody = document.querySelector('#transaction-table tbody');

    //     // Xóa nội dung cũ trong bảng
    //     tableBody.innerHTML = '';

    //     // Duyệt qua dữ liệu và thêm vào bảng
    //     tableData.forEach(rowData => {
    //       const newRow = document.createElement('tr');
    //       newRow.id = `row-${rowData.id.replace('T', '')}`; // Gán ID duy nhất cho hàng
    //       newRow.innerHTML = `
    //         <td>${rowData.id}</td>
    //         <td>${rowData.originalTransactionId}</td>
    //         <td>${rowData.transactionType}</td>
    //         <td>${rowData.status}</td>
    //         <td>${rowData.amount}</td>
    //         <td>${rowData.amountUpdate}</td>
    //         <td>${rowData.day}</td>
    //         <td>
    //           ${
    //             rowData.transactionType === 'sale'
    //               ? `
    //                 <button class="edit-btn void-btn" onclick="voidTransaction('${rowData.id}')" 
    //                   ${rowData.status === 'new' ? '' : 'disabled style="opacity: 0.5; cursor: not-allowed;"'}>
    //                   Void
    //                 </button>
    //                 <button class="edit-btn refund-btn" onclick="refundTransaction('${rowData.id}')" 
    //                   ${rowData.status === 'new' ? '' : 'disabled style="opacity: 0.5; cursor: not-allowed;"'}>
    //                   Refund
    //                 </button>
    //               `
    //               : ''
    //           }
    //         </td>
    //       `;
    //       tableBody.appendChild(newRow);
    //     });

    //     // Lấy ID cuối cùng trong bảng và cập nhật transactionIdCounter
    //     const lastRow = tableData[tableData.length - 1];
    //     if (lastRow) {
    //       transactionIdCounter = parseInt(lastRow.id.replace('T', ''), 10); // Cập nhật transactionIdCounter

    //       // Lấy ngày cuối cùng và cập nhật dayCounter
    //       const lastDay = lastRow.day.replace('T + ', ''); // Lấy số ngày từ chuỗi "T + X"
    //       dayCounter = parseInt(lastDay, 10) + 1; // Cập nhật dayCounter cho giao dịch tiếp theo
    //     } else {
    //       // Nếu không có dữ liệu, bắt đầu từ T + 0
    //       dayCounter = 0;
    //     }

    //     // Cập nhật combobox giao dịch Sale
    //     updateSaleTransactionDropdown();

    //     alert('Dữ liệu đã được tải từ file!');
    //   };

    //   reader.readAsText(file); // Đọc file JSON
    // }

    function resetLocalStorage() {
      // Xóa dữ liệu trong Local Storage
      localStorage.removeItem('transactionTable');

      // Làm trống bảng
      const tableBody = document.querySelector('#transaction-table tbody');
      tableBody.innerHTML = '';

      // Đặt lại transactionIdCounter
      transactionIdCounter = 0;
      dayCounter = 0;

      // Cập nhật combobox giao dịch Sale
      updateSaleTransactionDropdown();

      alert('Local Storage đã được reset và bảng đã được làm trống!');
    }

    function loadTableFromFile(event) {
      const file = event.target.files[0]; // Lấy file được chọn
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const tableData = JSON.parse(e.target.result); // Parse nội dung file JSON
        const tableBody = document.querySelector('#transaction-table tbody');

        // Xóa nội dung cũ trong bảng
        tableBody.innerHTML = '';

        // Duyệt qua dữ liệu và thêm vào bảng
        tableData.forEach(rowData => {
          const newRow = document.createElement('tr');
          newRow.id = `row-${rowData.id.replace('T', '')}`; // Gán ID duy nhất cho hàng
          newRow.innerHTML = `
            <td>${rowData.id}</td>
            <td>
            ${
              rowData.transactionType === 'void'
                ? `<span class="original-void">${rowData.originalTransactionId}</span>` // Màu đỏ cho void
                : rowData.transactionType === 'refund'
                ? `<span class="original-refund">${rowData.originalTransactionId}</span>` // Màu xanh cho refund
                : rowData.originalTransactionId // Không thay đổi nếu không phải void hoặc refund
            }
          </td>
            <td>${rowData.transactionType}</td>
            <td>${rowData.status}</td>
            <td>${rowData.amount}</td>
            <td>${rowData.amountUpdate}</td>
            <td>${rowData.day}</td>
            <td>${rowData.dayVoided}</td>
            <td>${rowData.dayRefunded}</td>
            <td>
              ${rowData.status === 'new' ? `
                <button class="edit-btn" onclick="voidTransaction('${rowData.id}')">Void</button>
                <button class="edit-btn" onclick="refundTransaction('${rowData.id}')">Refund</button>
              ` : ''}
            </td>
          `;
          tableBody.appendChild(newRow);
        });

        // Lấy ID cuối cùng trong bảng và cập nhật transactionIdCounter
        const lastRow = tableData[tableData.length - 1];
        if (lastRow) {
          transactionIdCounter = parseInt(lastRow.id.replace('T', ''), 10); // Cập nhật transactionIdCounter
        }

        // Cập nhật combobox giao dịch Sale
        updateSaleTransactionDropdown();

        alert('Dữ liệu đã được tải từ file!');
      };

      reader.readAsText(file); // Đọc file JSON
    }

    function statement(day) {
      alert(`Đã đạt đến ngày ${day}. Gọi hàm statement!`);
      // Thêm logic xử lý tại đây
      const tableRows = document.querySelectorAll('#transaction-table tbody tr');
      let sumNew = 0;
      let sumVoided = 0;
      let sumRefunded = 0;

      // Duyệt qua các hàng trong bảng giao dịch
      tableRows.forEach(row => {
        const transactionType = row.children[2].textContent; // Loại giao dịch
        const status = row.children[3].textContent; // Trạng thái
        const amount = parseFloat(row.children[4].textContent) || 0; // Số tiền

        // Chỉ tính tổng cho giao dịch loại "sale"
        if (transactionType === 'sale') {
          if (status === 'new') {
            sumNew += amount;
          } else if (status === 'voided') {
            sumVoided += amount;
          } else if (status === 'refunded') {
            sumRefunded += amount;
          }
        }
      });

      // Cập nhật bảng tổng hợp
      document.getElementById('sum-new').textContent = sumNew.toFixed(2);
      document.getElementById('sum-voided').textContent = sumVoided.toFixed(2);
      document.getElementById('sum-refunded').textContent = sumRefunded.toFixed(2);
    }

    function calculateStatement() {
      const tableRows = document.querySelectorAll('#transaction-table tbody tr');
      let sumNew = 0;
      let sumVoided = 0;
      let sumRefunded = 0;
      let sumPayment = 0;
      let sumCash = 0;
      let sumFee = 0; // Biến để lưu tổng số tiền phí
      let i = 0;

      addLog("tableRows.length: " + tableRows.length);
      addDelimiterRow();
      //lastIndex = 0;

      // Duyệt qua các hàng trong bảng giao dịch
      for (i = lastIndex; i < tableRows.length; i++) 
      {
          const row = tableRows[i];

          // Kiểm tra nếu hàng là delimiter (có nội dung là "---")
          const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng

          // Kiểm tra nếu hàng không có đủ số lượng ô
          if (cells.length < 5) {
            continue; // Bỏ qua hàng không hợp lệ
          }
          //addLog(cells.length);

          const transactionType = row.children[2].textContent; // Loại giao dịch
          const status = row.children[3].textContent; // Trạng thái
          const amount = parseInt(row.children[4].textContent) || 0; // Số tiền gốc

            // Xử lý giao dịch sale
          if (transactionType === 'sale') {
              if (status === 'new') {
                // Lấy số tiền gốc cho giao dịch sale có trạng thái new
                sumNew += amount;
              } else if (status === 'refunded') {
                // Lấy số tiền cập nhật cho giao dịch sale có trạng thái refunded
                const updatedAmount = parseInt(row.children[5].textContent) || 0; // Cột thứ 6 chứa số tiền cập nhật
                sumNew += updatedAmount;
              } else if (status === 'voided') {
                // Không tính giao dịch sale đã voided
                continue;
              }
          }

          // Tính tổng cho giao dịch voided (lấy từ cột Số Tiền Gốc)
          if (transactionType === 'void') {
              sumVoided += 0; // Lấy giá trị từ cột Số Tiền Gốc
              addLog(`sumVoided: ${sumVoided}`);
          }

          // Tính tổng cho giao dịch refunded (lấy từ cột Số Tiền Gốc)
          if (transactionType === 'refund') {
              sumRefunded += 0; // Lấy giá trị từ cột Số Tiền Gốc
          }

          // Tính tổng cho giao dịch payment (lấy từ cột Số Tiền Gốc)
          if (transactionType === 'payment') {
              //sumPayment += amount; // Lấy giá trị từ cột Số Tiền Gốc
              sumPayment = amountPaymentInCycle;
              addLog(`sumPayment: ${sumPayment}`);
          }

          // Xử lý giao dịch cash
          if (transactionType === 'cash') {
              if (status === 'new') {
                // Lấy số tiền gốc cho giao dịch cash có trạng thái new
                sumCash += amount;
              } else if (status === 'refunded') {
                // Lấy số tiền cập nhật cho giao dịch cash có trạng thái refunded
                const updatedAmount = parseInt(row.children[5].textContent) || 0; // Cột thứ 6 chứa số tiền cập nhật
                sumCash += updatedAmount;
              } else if (status === 'voided') {
                // Không tính giao dịch cash đã voided
                continue;
              }
          }

          // Xử lý giao dịch fee
          if (transactionType === 'fee') {
              if (status === 'new') {
                // Lấy số tiền fee chưa void
                const feeAmount = parseFloat(row.children[4].textContent) || 0; // Cột thứ 4 chứa số tiền gốc
                sumFee += feeAmount; // Cộng số tiền fee 
              } else if (status === 'voided') {
                // Không tính giao dịch fee đã voided
                continue;
              }
          }
      }

      addLog(`sumNew: ${sumNew}, sumVoided: ${sumVoided}, sumRefunded: ${sumRefunded}, sumCash: ${sumCash}`);

      // Cập nhật bảng tổng hợp
      document.getElementById('sum-new').textContent = sumNew.toFixed(2);
      document.getElementById('sum-voided').textContent = sumVoided.toFixed(2);
      document.getElementById('sum-refunded').textContent = sumRefunded.toFixed(2);
      document.getElementById('sum-cash').textContent = sumCash.toFixed(2);
      document.getElementById('sum-payment').textContent = sumPayment.toFixed(2);
      document.getElementById('sum-fee').textContent = sumFee.toFixed(2);

      // Hiển thị số tiền gốc trong bảng giao dịch
      document.getElementById('statement-original-amount-sale-label').textContent = `Số tiền sale trong kỳ: ${(sumNew).toFixed(2)}`;
      document.getElementById('statement-original-amount-cash-label').textContent = `Số tiền cash trong kỳ: ${(sumCash).toFixed(2)}`;
      document.getElementById('statement-original-amount-payment-label').textContent = `Số tiền payment trong kỳ: ${(sumPayment).toFixed(2)}`;
      document.getElementById('statement-original-amount-fee-label').textContent = `Số tiền fee trong kỳ: ${(sumFee).toFixed(2)}`;
      document.getElementById('statement-original-amount-label').textContent = `Tổng tiền gốc trong kỳ: (sale + cash + fee - payment) = ${(sumNew + sumCash + sumFee - sumPayment).toFixed(2)}`;


      // Lấy số tiền từ hàng cuối trong bảng bucket-list-table
      const bucketTableRows = document.querySelectorAll('#bucket-list-table tbody tr');
      let sumValue = 0;
      let paymentValue = 0;

      if (bucketTableRows.length > 0) {
        const lastRow = bucketTableRows[bucketTableRows.length - 1];
        const descriptionCell = lastRow.querySelector('td:nth-child(2)'); // Cột chứa description

        if (descriptionCell) {
          const descriptionText = descriptionCell.textContent || ''; // Lấy nội dung của description

          // Trích xuất giá trị Sum từ description
          const sumMatch = descriptionText.match(/Sum: ([\d.]+)/);
          sumValue = sumMatch ? parseFloat(sumMatch[1]) : 0;

          // Trích xuất giá trị Payment từ description
          const paymentMatch = descriptionText.match(/Paid: ([\d.]+)/);
          paymentValue = paymentMatch ? parseFloat(paymentMatch[1]) : 0;
        }
      }

      addLog(`Sum: ${sumValue}`); // Hiển thị giá trị Sum
      addLog(`Payment: ${paymentValue}`); // Hiển thị giá trị Payment

      openingDebt = sumValue - paymentValue; // Tính toán nợ mở kỳ

      // Hiển thị dư nợ đầu kỳ
      document.getElementById('statement-opening-debt-sale-label').textContent = `Dư nợ đầu kỳ: ${openingDebt.toFixed(2)}`;

      updateInterestTable(); // Cập nhật bảng tính lãi
      lastIndex = i; // Cập nhật lastIndex để tránh tính lại các hàng đã tính lãi
      cycle++; // Tăng cycleCounter mỗi lần tính lãi

      // Bật lại nút create-sample-btn
      const createButton = document.getElementById('create-sample-btn');
      createButton.disabled = false; // Bật lại nút
      createButton.style.opacity = 1; // Xóa hiệu ứng mờ
      createButton.style.cursor = 'pointer'; // Đổi con trỏ chuột về trạng thái bình thường

      //disable nút calculate-btn
      const calculateButton = document.getElementById('cal-statement');
      calculateButton.disabled = true; // Vô hiệu hóa nút
      addLineInLog();
      dayCounter+= 25; // Tăng dayCounter mỗi lần tính lãi
    }

    
    function updateInterestTable() {
      const tableRows = document.querySelectorAll('#transaction-table tbody tr');
      const interestTableBody = document.querySelector('#interest-table tbody');
      const annualInterestRate = 0.2; // Lãi suất 20% mỗi năm
      const interestRate = annualInterestRate / 365; // Lãi suất mỗi ngày

      const annualInterestRateCash = 0.2; // Lãi suất 20% mỗi năm cho giao dịch cash
      const interestRateCash = annualInterestRateCash / 365; // Lãi suất mỗi ngày cho cash

      const annualInterestRateFee = 0.2; // Lãi suất 20% mỗi năm cho giao dịch fee
      const interestRateFee = annualInterestRateFee / 365; // Lãi suất mỗi ngày cho fee

      let totalInterest = 0; // Biến lưu tổng lãi suất
      let totalCashAmount = 0; // Biến lưu tổng số tiền cash
      let totalSaleAmount = 0; // Biến lưu tổng số tiền sale
      let totalFeeAmount = 0; // Biến lưu tổng số tiền fee
      let bucketInterest = 0; // Biến lưu bucket lãi
      let bucketOld = 0; // Biến lưu bucket old

      // Xóa nội dung cũ trong bảng tính lãi
      interestTableBody.innerHTML = '';

      // Lấy ngày cuối cùng trong bảng
      let maxDay = 0;
      tableRows.forEach(row => {
        const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
        if (cells.length < 5) {
          return; // Bỏ qua hàng không hợp lệ
        }

        const dayString = row.children[9].textContent.replace('T + ', ''); // Lấy số ngày từ chuỗi "T + X"
        const transactionDay = parseInt(dayString, 10); // Chuyển đổi thành số nguyên
        if (transactionDay > maxDay) {
          maxDay = transactionDay; // Cập nhật ngày cuối cùng
        }
      });
      maxDay = Math.ceil((maxDay + 1) / 25) * 25; // Làm tròn lên bội số của 25

      // Hiển thị ngày sao kê
      document.getElementById('statement-date-label').textContent = `Cycle ${cycle + 1} - Ngày sao kê: T + ${((cycle + 1) * 25)}`;

      // Duyệt qua các hàng trong bảng giao dịch
      for (let i = lastIndex; i < tableRows.length; i++) {
        const row = tableRows[i];
        const cells = row.querySelectorAll('td');
        if (cells.length < 5) {
          continue; // Bỏ qua hàng không hợp lệ
        }

        const transactionId = row.children[0].textContent; // ID Giao Dịch
        const transactionType = row.children[2].textContent; // Loại Giao Dịch
        const status = row.children[3].textContent; // Trạng thái
        const amount = parseFloat(row.children[4].textContent) || 0; // Số Tiền Gốc
        const updatedAmount = parseFloat(row.children[5].textContent) || 0; // Số Tiền Cập Nhật
        const dayString = row.children[9].textContent.replace('T + ', ''); // Lấy số ngày từ chuỗi "T + X"
        const transactionDay = parseInt(dayString, 10); // Chuyển đổi thành số nguyên
        const refundDayString = row.children[8]?.textContent.replace('T + ', '') || ''; // Lấy ngày refund từ cột thứ 9
        const refundDay = parseInt(refundDayString, 10) || 0; // Chuyển đổi thành số nguyên

        // Tính số ngày tính lãi
        let daysElapsed = 0;

        if (transactionType === 'sale' && status === 'new') 
        {
          daysElapsed = maxDay - transactionDay;
          let interest = 0;
          if(calInterestForSale == true)
            interest = amount * interestRate * daysElapsed;
          else
            interest = 0; 

          const newRow = document.createElement('tr');
          newRow.innerHTML = `
            <td>${transactionId}</td>
            <td>${transactionType}</td>
            <td>${amount.toFixed(2)}</td>
            <td>${daysElapsed}</td>
            <td>${row.children[9].textContent}</td>
            <td>${'T + ' + maxDay}</td>
            <td>${interest.toFixed(2)}</td>
          `;
          interestTableBody.appendChild(newRow);
          totalInterest += interest;
          totalSaleAmount += amount;
        } 
        else if (transactionType === 'sale' && status === 'refunded' && updatedAmount > 0) 
        {
          const daysToRefund = refundDay - transactionDay;
          const interestOriginal = amount * interestRate * daysToRefund;

          const newRow1 = document.createElement('tr');
          newRow1.innerHTML = `
            <td>${transactionId} (Gốc)</td>
            <td>${transactionType}</td>
            <td>${amount.toFixed(2)}</td>
            <td>${daysToRefund}</td>
            <td>${row.children[9].textContent}</td>
            <td>${row.children[8]?.textContent || ''}</td>
            <td>${interestOriginal.toFixed(2)}</td>
          `;
          interestTableBody.appendChild(newRow1);

          const daysFromRefund = maxDay - refundDay;
          const interestUpdated = updatedAmount * interestRate * daysFromRefund;

          const newRow2 = document.createElement('tr');
          newRow2.innerHTML = `
            <td>${transactionId} (Cập nhật)</td>
            <td>${transactionType}</td>
            <td>${updatedAmount.toFixed(2)}</td>
            <td>${daysFromRefund}</td>
            <td>${row.children[8]?.textContent || ''}</td>
            <td>${'T + ' + maxDay}</td>
            <td>${interestUpdated.toFixed(2)}</td>
          `;
          interestTableBody.appendChild(newRow2);
          totalInterest += interestOriginal + interestUpdated;
          totalSaleAmount += updatedAmount;
        } 
        else if (transactionType === 'cash' && status === 'new') 
        {
          daysElapsed = maxDay - transactionDay;
          const interest = amount * interestRateCash * daysElapsed;

          const newRow = document.createElement('tr');
          newRow.innerHTML = `
            <td>${transactionId}</td>
            <td>${transactionType}</td>
            <td>${amount.toFixed(2)}</td>
            <td>${daysElapsed}</td>
            <td>${row.children[9].textContent}</td>
            <td>${'T + ' + maxDay}</td>
            <td>${interest.toFixed(2)}</td>
          `;
          interestTableBody.appendChild(newRow);
          totalInterest += interest;
          totalCashAmount += amount;
        } 
        else if (transactionType === 'fee' && status === 'new') 
        {
          daysElapsed = maxDay - transactionDay;
          let interest = 0;
          if(calInterestForFee == true)
            interest = amount * interestRateFee * daysElapsed;
          else
            interest = 0; // Không tính lãi suất nếu không cần

          const newRow = document.createElement('tr');
          newRow.innerHTML = `
            <td>${transactionId}</td>
            <td>${transactionType}</td>
            <td>${amount.toFixed(2)}</td>
            <td>${daysElapsed}</td>
            <td>${row.children[9].textContent}</td>
            <td>${'T + ' + maxDay}</td>
            <td>${interest.toFixed(2)}</td>
          `;
          interestTableBody.appendChild(newRow);
          totalInterest += interest;
          totalFeeAmount += amount;
        }
      }

      // Tính bucket lãi và bucket old
      bucketInterest = totalInterest;
      bucketOld = totalSaleAmount + bucketInterest + totalCashAmount + totalFeeAmount;

      // Hiển thị số tiền gốc trong bảng giao dịch
      document.getElementById('statement-interest-label').textContent = `Số tiền lãi: ${totalInterest.toFixed(2)}`;
      const originAmountLabel = document.getElementById('statement-original-amount-label').textContent;
      const originAmount = parseFloat(originAmountLabel.replace('Tổng tiền gốc trong kỳ: (sale + cash + fee - payment) = ', '').replace(/,/g, '').trim()) || 0;
      const minimumAmount = (totalInterest + originAmount) * 0.2;

      document.getElementById('statement-min-amount-label').textContent = `Số tiền tối thiểu phải trả: 20% * (${originAmount.toFixed(2)} + ${totalInterest.toFixed(2)}) = ${minimumAmount.toFixed(2)}`;

      // Cập nhật description
      const description = `Bucket ${bucketIdCounter}: <br> 
        Sale bucket: ${totalSaleAmount.toFixed(2)}<br> 
        Cash bucket: ${totalCashAmount.toFixed(2)}<br> 
        Fee bucket: ${totalFeeAmount.toFixed(2)}<br> 
        Interest bucket: <span style="color: red;">${totalInterest.toFixed(2)}</span><br> 
        Bucket old: <span style="color: red;">${bucketOld.toFixed(2)}</span><br> 
        Sum: <span style="color: red;">${(totalSaleAmount + totalCashAmount + totalFeeAmount + totalInterest).toFixed(2)}</span><br> 
        Payment: 0.00`;

      addToBucketList(description, minimumAmount.toFixed(2));

      lastIndex = tableRows.length; // Cập nhật lastIndex để tránh tính lại các hàng đã tính toán trước đó
    }

    function updateInterestTable_org() {
        const tableRows = document.querySelectorAll('#transaction-table tbody tr');
        const interestTableBody = document.querySelector('#interest-table tbody');
        const annualInterestRate = 0.2; // Lãi suất 20% mỗi năm
        const interestRate = annualInterestRate / 365; // Lãi suất mỗi ngày

        const annualInterestRateCash = 0.2; // Lãi suất 20% mỗi năm cho giao dịch cash
        const interestRateCash = annualInterestRateCash / 365; // Lãi suất mỗi ngày cho cash
        let totalInterest = 0; // Biến lưu tổng lãi suất
        let totalCashAmount = 0; // Biến lưu tổng số tiền cash
        let totalSaleAmount = 0; // Biến lưu tổng số tiền sale
        let bucketInterest = 0; // Biến lưu bucket lãi
        let bucketOld = 0; // Biến lưu bucket old

        // Xóa nội dung cũ trong bảng tính lãi
        interestTableBody.innerHTML = '';

        // Lấy ngày cuối cùng trong bảng
        let maxDay = 0;
        tableRows.forEach(row => {
          const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
          // Kiểm tra nếu hàng không có đủ số lượng ô
          if (cells.length < 5) {
            return; // Bỏ qua hàng không hợp lệ
          }

          const dayString = row.children[9].textContent.replace('T + ', ''); // Lấy số ngày từ chuỗi "T + X"
          const transactionDay = parseInt(dayString, 10); // Chuyển đổi thành số nguyên
          if (transactionDay > maxDay) {
            maxDay = transactionDay; // Cập nhật ngày cuối cùng
          }
        });
        //maxDay += 1; // Cộng thêm 1 vào ngày cuối cùng
        maxDay = Math.ceil((maxDay + 1) / 25) * 25; // Làm tròn lên bội số của 25

        // Hiển thị ngày sao kê
        document.getElementById('statement-date-label').textContent = `Cycle ${cycle + 1} - Ngày sao kê: T + ${((cycle+1) * 25)}`; // Cập nhật ngày sao kê;

        // Duyệt qua các hàng trong bảng giao dịch
        for (i = lastIndex; i < tableRows.length; i++) 
        {
          const row = tableRows[i];
          const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
          // Kiểm tra nếu hàng không có đủ số lượng ô
          if (cells.length < 5) {
            continue; // Bỏ qua hàng không hợp lệ
        }
        
        const transactionId = row.children[0].textContent; // ID Giao Dịch
        const transactionType = row.children[2].textContent; // Loại Giao Dịch
        const status = row.children[3].textContent; // Trạng thái
        const amount = parseFloat(row.children[4].textContent) || 0; // Số Tiền Gốc
        const updatedAmount = parseFloat(row.children[5].textContent) || 0; // Số Tiền Cập Nhật
        const dayString = row.children[9].textContent.replace('T + ', ''); // Lấy số ngày từ chuỗi "T + X"
        const transactionDay = parseInt(dayString, 10); // Chuyển đổi thành số nguyên
        const refundDayString = row.children[8]?.textContent.replace('T + ', '') || ''; // Lấy ngày refund từ cột thứ 9
        const refundDay = parseInt(refundDayString, 10) || 0; // Chuyển đổi thành số nguyên

        // Tính số ngày tính lãi
        let daysElapsed = 0;

        if (transactionType === 'sale' && status === 'new') {
          daysElapsed = maxDay - transactionDay; // Ngày cuối cùng trừ đi ngày giao dịch
          const interest = amount * interestRate * daysElapsed; // Tiền lãi = Số tiền gốc * Lãi suất * Số ngày

          // Thêm dòng vào bảng chi tiết tính lãi
          const newRow = document.createElement('tr');
          newRow.innerHTML = `
            <td>${transactionId}</td>
            <td>${transactionType}</td>
            <td>${amount.toFixed(2)}</td>
            <td>${daysElapsed}</td>
            <td>${row.children[9].textContent}</td>
            <td>${'T + ' + maxDay}</td>
            <td>${interest.toFixed(2)}</td>
          `;
          interestTableBody.appendChild(newRow);
          totalInterest += interest; // Cộng dồn lãi suất vào tổng
          totalSaleAmount += amount; // Cộng dồn số tiền sale vào tổng
        } 
        else if (transactionType === 'sale' && status === 'refunded' && updatedAmount > 0) 
        {
          const daysToRefund = refundDay - transactionDay; // Số ngày từ ngày giao dịch đến ngày refund
          const interestOriginal = amount * interestRate * daysToRefund; // Tiền lãi cho số tiền gốc

          const newRow1 = document.createElement('tr');
          newRow1.innerHTML = `
            <td>${transactionId} (Gốc)</td>
            <td>${transactionType}</td>
            <td>${amount.toFixed(2)}</td>
            <td>${daysToRefund}</td>
            <td>${row.children[9].textContent}</td>
            <td>${row.children[8]?.textContent || ''}</td>
            <td>${interestOriginal.toFixed(2)}</td>
          `;
          interestTableBody.appendChild(newRow1);

          const daysFromRefund = maxDay - refundDay; // Số ngày từ ngày refund đến ngày sao kê
          const interestUpdated = updatedAmount * interestRate * daysFromRefund; // Tiền lãi cho số tiền cập nhật

          const newRow2 = document.createElement('tr');
          newRow2.innerHTML = `
            <td>${transactionId} (Cập nhật)</td>
            <td>${transactionType}</td>
            <td>${updatedAmount.toFixed(2)}</td>
            <td>${daysFromRefund}</td>
            <td>${row.children[8]?.textContent || ''}</td>
            <td>${'T + ' + maxDay}</td>
            <td>${interestUpdated.toFixed(2)}</td>
          `;
          interestTableBody.appendChild(newRow2);
          totalInterest += interestOriginal + interestUpdated; // Cộng dồn lãi suất vào tổng
          totalSaleAmount += updatedAmount; // Cộng dồn số tiền sale vào tổng
        } 
        else if (transactionType === 'cash' && status === 'new') 
        {
          daysElapsed = maxDay - transactionDay; // Ngày cuối cùng trừ đi ngày giao dịch
          const interest = amount * interestRateCash * daysElapsed; // Tiền lãi = Số tiền gốc * Lãi suất * Số ngày

          const newRow = document.createElement('tr');
          newRow.innerHTML = `
            <td>${transactionId}</td>
            <td>${transactionType}</td>
            <td>${amount.toFixed(2)}</td>
            <td>${daysElapsed}</td>
            <td>${row.children[9].textContent}</td>
            <td>${'T + ' + maxDay}</td>
            <td>${interest.toFixed(2)}</td>
          `;
          interestTableBody.appendChild(newRow);
          totalInterest += interest; // Cộng dồn lãi suất vào tổng
          totalCashAmount += amount; // Cộng dồn số tiền cash vào tổng
        }
        else if (transactionType === 'payment' && status === 'completed') {
          daysElapsed = maxDay - transactionDay; // Ngày cuối cùng trừ đi ngày giao dịch
          const interest = amount * 0 * daysElapsed; // Tiền lãi = Số tiền gốc * Lãi suất * Số ngày

          // Thêm dòng vào bảng chi tiết tính lãi
          const newRow = document.createElement('tr');
          newRow.innerHTML = `
            <td>${transactionId}</td>
            <td>${transactionType}</td>
            <td>${amount.toFixed(2)}</td>
            <td>${daysElapsed}</td>
            <td>${row.children[9].textContent}</td>
            <td>${'T + ' + maxDay}</td>
            <td>${interest.toFixed(2)}</td>
          `;
          interestTableBody.appendChild(newRow);
          //totalInterest += interest; // Cộng dồn lãi suất vào tổng
          //totalPaymentAmount += amount; // Cộng dồn số tiền payment vào tổng
        }
      };

      // Tính bucket lãi và bucket old
      bucketInterest = totalInterest; // Bucket lãi là tổng lãi suất
      bucketOld = totalSaleAmount + bucketInterest + totalCashAmount; // Bucket old là tổng của sale, lãi, và cash

      // Hiển thị số tiền gốc trong bảng giao dịch
      document.getElementById('statement-interest-label').textContent = `Số tiền lãi: ${totalInterest.toFixed(2)}`;
      const originAmountLabel = document.getElementById('statement-original-amount-label').textContent; // Lấy nội dung của label
      addLog("tiền gốc " + originAmountLabel); // Hiển thị nội dung của label trong console
      const originAmount = parseFloat(originAmountLabel.replace('Tổng tiền gốc trong kỳ: ', '').replace(/,/g, '').trim()) || 0; // Loại bỏ chữ và chuyển thành số
      const minimumAmount = (totalInterest + originAmount) * 0.2; // Số tiền tối thiểu phải trả, 20% tổng số tiền
      
      document.getElementById('statement-min-amount-label').textContent = `Số tiền tối thiểu phải trả: 20% * (${originAmount.toFixed(2)} + ${totalInterest.toFixed(2)}) = ${minimumAmount.toFixed(2)}`;
      const saleAmountLabel = document.getElementById('statement-original-amount-sale-label').textContent; // Lấy nội dung của label sale
      const saleAmount = parseFloat(saleAmountLabel.replace('Số tiền sale trong kỳ: ', '').replace(/,/g, '').trim()) || 0; // Loại bỏ chữ và chuyển thành số
      
      // Lấy số tiền từ hàng trên trong bảng bucket-list-table
      const bucketTableRows = document.querySelectorAll('#bucket-list-table tbody tr');
      let previousSaleBucket = 0;
      let previousCashBucket = 0;
      let previousInterestBucket = 0;
      let previousPayment = 0;

      if (bucketTableRows.length > 0) {
        const lastRow = bucketTableRows[bucketTableRows.length - 1];
        const descriptionCell = lastRow.querySelector('td:nth-child(2)'); // Cột chứa description

        if (descriptionCell) {
          const descriptionText = descriptionCell.textContent || ''; // Lấy nội dung của description

          // Trích xuất giá trị từ description
          const saleBucketMatch = descriptionText.match(/Sale bucket: ([\d.]+)/);
          const cashBucketMatch = descriptionText.match(/Cash bucket: ([\d.]+)/);
          const interestBucketMatch = descriptionText.match(/Interest bucket: ([\d.]+)/);
          const bucketOldMatch = descriptionText.match(/Bucket old: ([\d.]+)/);

          previousSaleBucket = saleBucketMatch ? parseFloat(saleBucketMatch[1]) : 0;
          previousCashBucket = cashBucketMatch ? parseFloat(cashBucketMatch[1]) : 0;
          previousInterestBucket = interestBucketMatch ? parseFloat(interestBucketMatch[1]) : 0;
          previousPayment = bucketOldMatch ? parseFloat(bucketOldMatch[1]) : 0; // Bucket old được sử dụng như số tiền trả
        }
      }

      // Tính bucket old
      bucketOld = (previousSaleBucket + previousCashBucket + previousInterestBucket) - previousPayment;

      // Cập nhật description
      const description = `Bucket ${bucketIdCounter}: <br> 
      Sale bucket: ${saleAmount.toFixed(2)}<br> 
      Cash bucket: ${totalCashAmount.toFixed(2)}<br> 
      Interest bucket: <span style="color: red;">${totalInterest.toFixed(2)}</span><br> 
      Bucket old: <span style="color: red;">${bucketOld.toFixed(2)}</span><br> 
      Sum: <span style="color: red;">${(saleAmount + totalCashAmount + totalInterest).toFixed(2)}</span><br> 
      Payment: 0.00`;
      //const description = `Bucket ${bucketIdCounter}: <br> Sale bucket: ${saleAmount.toFixed(2)}<br> Cash bucket: ${totalCashAmount.toFixed(2)}`;
      addToBucketList(description, minimumAmount.toFixed(2));

      // Hiển thị bucket lãi và bucket old
      //document.getElementById('statement-bucket-interest-label').textContent = `Bucket lãi: ${bucketInterest.toFixed(2)}`;
      //document.getElementById('statement-bucket-old-label').textContent = `Bucket old: ${bucketOld.toFixed(2)}`;
      lastIndex = tableRows.length; // Cập nhật lastIndex để tránh tính lại các hàng đã tính toán trước đó
    }


    function createSampleTransactions() {
      const tableBody = document.querySelector('#transaction-table tbody');
      //const totalTransactions = Math.floor(Math.random() * 21) + 5; // Số ngẫu nhiên từ 5 đến 25 - số giao dịch cần tạo
      const totalTransactions = Math.floor(Math.random() * 21) + 1; // Số ngẫu nhiên từ 5 đến 25 - số giao dịch cần tạo
      let saleTransactions = []; // Lưu trữ các giao dịch sale để làm ID gốc cho void và refund

      // Tạo giao dịch mẫu
      for (let i = 1; i <= totalTransactions; i++) {
        const transactionId = `T${transactionIdCounter + i}`;
        const day = `T + ${dayCounter + i - 1}`;
        let transactionType, originalTransactionId, status, amount;
        dayVoided = '-';
        dayRefunded = '-';


        if (i <= 15) {
          // Tạo 15 giao dịch sale
          transactionType = 'sale';
          originalTransactionId = '';
          status = 'new';
          amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
          saleTransactions.push({ id: transactionId, status }); // Lưu ID và trạng thái giao dịch sale
        } else if (i <= 20) {
          // Tạo 5 giao dịch void
          const validSales = saleTransactions.filter(sale => sale.status === 'new'); // Chỉ lấy các giao dịch sale có trạng thái new
          if (validSales.length === 0) {
            //alert('Không có giao dịch sale nào với trạng thái new để tạo void!');
            break; // Thoát khỏi vòng lặp nếu không có giao dịch hợp lệ
          }
          const selectedSale = validSales[Math.floor(Math.random() * validSales.length)]; // Chọn ngẫu nhiên một giao dịch hợp lệ

          // Kiểm tra nếu giao dịch đã được refund thì không cho void
          const currentRow = document.querySelector(`#row-${selectedSale.id.replace('T', '')}`);
          if (currentRow && currentRow.children[3].textContent === 'refunded') {
            //alert(`Giao dịch ${selectedSale.id} đã được refund, không thể tạo void!`);
            continue; // Bỏ qua giao dịch này
          }

          transactionType = 'void';
          // originalTransactionId = selectedSale.id; // Lấy ID gốc từ giao dịch sale hợp lệ
          originalTransactionId = `<span class="original-void">${selectedSale.id}</span>`; // Thêm class màu đỏ
          //dayVoided = currentRow.children[6].textContent; // Ngày lấy từ gd sale
          status = 'voided';
          //amount = 0; // Void không có số tiền

          // Lấy số tiền từ giao dịch sale gốc
          const saleAmount = parseInt(currentRow.children[4].textContent) || 0; // Cột thứ 5 chứa số tiền gốc
          amount = saleAmount; // Gán số tiền từ giao dịch sale gốc cho giao dịch void

          // Cập nhật trạng thái của giao dịch sale gốc
          if (currentRow) {
            currentRow.children[3].textContent = "voided"; // Cập nhật trạng thái thành voided
            currentRow.children[7].textContent = day; // Cập nhật ngày voided
            const buttons = currentRow.querySelectorAll('button');
            buttons.forEach(button => {
              button.disabled = true;
              button.style.opacity = 0.5; // Thêm hiệu ứng mờ
              button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
            });
          }

          // Cập nhật trạng thái của giao dịch sale gốc trong mảng saleTransactions
          const saleIndex = saleTransactions.findIndex(sale => sale.id === selectedSale.id);
          if (saleIndex !== -1) {
            saleTransactions[saleIndex].status = 'voided'; // Cập nhật trạng thái thành voided
          }
        } else {
          // Tạo 5 giao dịch refund
          const validSales = saleTransactions.filter(sale => sale.status === 'new'); // Chỉ lấy các giao dịch sale có trạng thái new
          if (validSales.length === 0) {
            //alert('Không có giao dịch sale nào với trạng thái new để tạo refund!');
            break; // Thoát khỏi vòng lặp nếu không có giao dịch hợp lệ
          }
          const selectedSale = validSales[Math.floor(Math.random() * validSales.length)]; // Chọn ngẫu nhiên một giao dịch hợp lệ

          // Kiểm tra nếu giao dịch đã được voided thì không cho refund
          const currentRow = document.querySelector(`#row-${selectedSale.id.replace('T', '')}`);
          if (currentRow && currentRow.children[3].textContent === 'voided') {
            //alert(`Giao dịch ${selectedSale.id} đã được voided, không thể tạo refund!`);
            continue; // Bỏ qua giao dịch này
          }

          transactionType = 'refund';
          // originalTransactionId = selectedSale.id; // Lấy ID gốc từ giao dịch sale hợp lệ
          originalTransactionId = `<span class="original-refund">${selectedSale.id}</span>`; // Thêm class màu xanh
          //dayRefunded = currentRow.children[6].textContent; // Ngày lấy từ gd sale
          status = 'refunded';
          //amount = Math.floor(Math.random() * 5 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000

          // Lấy số tiền từ giao dịch sale gốc
          const saleAmount = parseInt(currentRow.children[4].textContent) || 0; // Cột thứ 5 chứa số tiền gốc

          // Tạo số tiền refund ngẫu nhiên, đảm bảo nhỏ hơn hoặc bằng số tiền gốc
          amount = Math.min(Math.floor(Math.random() * 5 + 1) * 1000, saleAmount); // Số tiền refund không vượt quá số tiền gốc

          // Cập nhật trạng thái của giao dịch sale gốc
          if (currentRow) {
            currentRow.children[3].textContent = "refunded"; // Cập nhật trạng thái thành refunded
            currentRow.children[8].textContent = day; // Cập nhật ngày refunded

            // Lấy số tiền gốc và số tiền cập nhật hiện tại
            const originalAmount = parseInt(currentRow.children[4].textContent) || 0; // Số tiền gốc (cột thứ 5)
            const updatedAmount = parseInt(currentRow.children[5].textContent) || originalAmount; // Số tiền cập nhật (cột thứ 6)

            // Tính số tiền còn lại sau khi refund
            const remainingAmount = updatedAmount - amount;

            // Cập nhật cột Số Tiền Cập Nhật
            currentRow.children[5].textContent = remainingAmount.toFixed(2);

            // Vô hiệu hóa các nút trong cột Hành Động
            const buttons = currentRow.querySelectorAll('button');
            buttons.forEach(button => {
              button.disabled = true;
              button.style.opacity = 0.5; // Thêm hiệu ứng mờ
              button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
            });
          }

          // Cập nhật trạng thái của giao dịch sale gốc trong mảng saleTransactions
          const saleIndex = saleTransactions.findIndex(sale => sale.id === selectedSale.id);
          if (saleIndex !== -1) {
            saleTransactions[saleIndex].status = 'refunded'; // Cập nhật trạng thái thành refunded
          }
        }

        // Thêm giao dịch trực tiếp vào bảng
        const newRow = document.createElement('tr');
        newRow.id = `row-${transactionId.replace('T', '')}`;
        newRow.innerHTML = `
          <td>${transactionId}</td>
          <td>${originalTransactionId}</td>
          <td>${transactionType}</td>
          <td>${status}</td>
          <td>${amount}</td>
          <td>${transactionType === 'sale' ? 0 : ''}</td>
          <td>${day}</td>
          <td>${dayVoided}</td>
          <td>${dayRefunded}</td>
          <td>
            ${
              transactionType === 'sale' && status === 'new'
                ? `
                  <button class="edit-btn" onclick="voidTransaction('${transactionId}')">Void</button>
                  <button class="edit-btn" onclick="refundTransaction('${transactionId}')">Refund</button>
                `
                : ''
            }
          </td>
        `;
        tableBody.appendChild(newRow);
      }

      // Thêm delimiter vào cuối bảng
      const delimiterRow = document.createElement('tr');
      delimiterRow.innerHTML = `
        <td colspan="10" style="background-color: #f0f0f0; text-align: center;">---</td>
      `;
      tableBody.appendChild(delimiterRow);

      // Cập nhật transactionIdCounter và dayCounter
      transactionIdCounter += totalTransactions;
      dayCounter += totalTransactions;

      //alert('25 giao dịch mẫu đã được tạo!');
    }




    function createRandomTransactions() {
      let maxTransactions = 20;
      const tableBody = document.querySelector('#transaction-table tbody');
      const totalTransactions = Math.floor(Math.random() * maxTransactions) + 2; // Số ngẫu nhiên từ 1 đến maxTransactions
      let transactions = []; // Lưu trữ các giao dịch sale và cash để làm ID gốc cho void
      const maxPostDay = cycle === 0 ? 25 : (cycle * 25); // Kiểm tra giá trị của cycle

      // Tạo giao dịch mẫu
      for (let i = 1; i <= totalTransactions; i++) 
      {
        const transactionId = `T${transactionIdCounter + i + lastIndex}`;
        const day = `T + ${dayCounter + i + (cycle*25) - 1}`;
        let transactionType, originalTransactionId, status, amount;
        dayVoided = '-';

        const randomType = Math.random(); // Giá trị ngẫu nhiên để quyết định loại giao dịch

        if (randomType < 0.5) {
          // Tạo giao dịch sale
          transactionType = 'sale';
          originalTransactionId = '';
          status = 'new';
          amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
          transactions.push({ id: transactionId, type: transactionType, status }); // Lưu giao dịch để làm ID gốc cho void
        } 
        else if (randomType < 0.8) 
        {
          // Tạo giao dịch cash
          transactionType = 'cash';
          originalTransactionId = '';
          status = 'new';
          amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
          transactions.push({ id: transactionId, type: transactionType, status }); // Lưu giao dịch để làm ID gốc cho void

          // Tạo giao dịch fee liên quan
          const feeTransactionId = `F${transactionId}`; // ID giao dịch fee
          const feeAmount = amount * 0.01; // Tính phí bằng 1% số tiền gốc
          const feeTransaction = {
            id: feeTransactionId,
            type: 'fee',
            status: 'new',
            originalTransactionId: transactionId, // Liên kết với giao dịch cash
            amount: feeAmount
          };
          transactions.push(feeTransaction); // Lưu giao dịch fee

          // Thêm giao dịch fee vào bảng
          const feeRow = document.createElement('tr');
          feeRow.id = `row-${feeTransactionId}`;
          feeRow.innerHTML = `
            <td>${feeTransactionId}</td>
            <td>${transactionId}</td>
            <td>fee</td>
            <td>${feeTransaction.status}</td>
            <td>${feeAmount.toFixed(2)}</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td></td>
          `;
          tableBody.appendChild(feeRow);
        } 
        else if (randomType < 0.9) {
          // Tạo giao dịch payment
          transactionType = 'payment';
          originalTransactionId = '';
          status = 'completed';
          amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
          transactions.push({ id: transactionId, type: transactionType, status }); // Lưu giao dịch payment

          // Rà lại bảng và cập nhật giao dịch theo thứ tự cash, fee, sale
          const tableRows = document.querySelectorAll('#transaction-table tbody tr');
          let remainingPayment = amount; // Số tiền payment còn lại để xử lý


          // Xử lý giao dịch cash và fee
          for (let i = 0; i < tableRows.length; i++) {
            const row = tableRows[i];
            const transactionType = row.children[2].textContent.trim(); // Loại giao dịch
            const status = row.children[3].textContent.trim(); // Trạng thái
            const orgAmountCell = row.children[4]; // Cột Số Tiền gốc
            const updatedAmountCell = row.children[5]; // Cột Số Tiền Cập Nhật
            const paidDayCell = row.children[10]; // Cột Ngày Paid
            let orgAmount = parseFloat(orgAmountCell.textContent) || 0; // Số Tiền Gốc
            let updatedAmount = parseFloat(updatedAmountCell.textContent) || 0; // Số Tiền Cập Nhật

            // Chỉ xử lý các giao dịch fee và cash có trạng thái "new" hoặc "refunded" hoặc "partial"
            if ((transactionType === 'cash' || transactionType === 'fee') &&
                (status === 'new' || status === 'refunded' || status === 'partial')) {
              
              if (remainingPayment >= orgAmount) {
                // Nếu số tiền payment đủ để thanh toán toàn bộ số tiền gốc
                remainingPayment -= orgAmount;
                updatedAmountCell.textContent = '0'; // Đặt số tiền cập nhật về 0
                row.children[3].textContent = 'paid'; // Cập nhật trạng thái thành "paid"
                paidDayCell.textContent = `T + ${dayCounter}`; // Cập nhật ngày paid

                // Thêm giao dịch payment vào bảng
                const newRow = document.createElement('tr');
                newRow.id = `row-${transactionId}`;
                newRow.innerHTML = `
                  <td>${transactionId}</td>
                  <td>${originalTransactionId}</td>
                  <td>${transactionType}</td>
                  <td>${status}</td>
                  <td>${amount}</td>
                  <td>-</td>
                  <td>${`T + ${dayCounter}`}</td>
                  <td>-</td>
                  <td>-</td>
                  <td>-</td>
                  <td>-</td>
                `;
                tableBody.appendChild(newRow);
              } 
              else 
              {
                // Nếu số tiền payment không đủ để thanh toán toàn bộ
                const remainingOrgAmount = orgAmount - remainingPayment; // Số tiền còn lại sau khi trừ payment
                remainingPayment = 0; // Đặt số tiền payment còn lại về 0

                // Cập nhật giao dịch hiện tại
                updatedAmountCell.textContent = remainingOrgAmount.toFixed(2); // Cập nhật số tiền còn lại
                paidDayCell.textContent = `T + ${dayCounter}`; // Cập nhật ngày paid

                // Thêm giao dịch payment vào bảng
                const newRowPayment = document.createElement('tr');
                newRowPayment.id = `row-${transactionId}`;
                newRowPayment.innerHTML = `
                  <td>${transactionId}</td>
                  <td>${originalTransactionId}</td>
                  <td>${transactionType}</td>
                  <td>${status}</td>
                  <td>${amount}</td>
                  <td>-</td>
                  <td>${`T + ${dayCounter}`}</td>
                  <td>-</td>
                  <td>-</td>
                  <td>-</td>
                  <td>-</td>
                `;
                tableBody.appendChild(newRowPayment);

                // Thêm một hàng mới cho giao dịch cash với số tiền còn lại
                const newRow = document.createElement('tr');
                newRow.innerHTML = ` 
                  <td>${row.children[0].textContent}-split</td> <!-- ID mới -->
                  <td>${row.children[1].textContent}</td> <!-- ID Giao Dịch Gốc -->
                  <td>${transactionType}</td> <!-- Loại Giao Dịch -->
                  <td>new</td> <!-- Trạng Thái -->
                  <td>${remainingOrgAmount.toFixed(2)}</td> <!-- Số Tiền Gốc -->
                  <td>-</td> <!-- Số Tiền Cập Nhật -->
                  <td>T + ${dayCounter}</td> <!-- Ngày -->
                  <td>-</td> <!-- Ngày Void -->
                  <td>-</td> <!-- Ngày Refund -->
                  <td>-</td> <!-- Ngày Post -->
                  <td>-</td> <!-- Ngày Paid -->
                `;
                tableBody.appendChild(newRow); // Thêm hàng mới vào bảng
              }

              // Nếu số tiền payment đã hết, thoát khỏi vòng lặp
              if (remainingPayment <= 0) {
                break;
              }
            }
          }
        }
        else 
        {
          // Tạo giao dịch void
          const validTransactions = transactions.filter(tx => tx.status === 'new'); // Chỉ lấy các giao dịch sale hoặc cash có trạng thái new
          if (validTransactions.length === 0) {
            continue; // Bỏ qua nếu không có giao dịch hợp lệ
          }
          const selectedTransaction = validTransactions[Math.floor(Math.random() * validTransactions.length)]; // Chọn ngẫu nhiên một giao dịch hợp lệ

          transactionType = 'void';
          originalTransactionId = `<span class="original-void">${selectedTransaction.id}</span>`; // Thêm class màu đỏ
          status = 'voided';
          amount = 0; // Void không có số tiền

          // Cập nhật trạng thái của giao dịch gốc
          const currentRow = document.querySelector(`#row-${selectedTransaction.id.replace('T', '')}`);
          if (currentRow) {
            const transactionDay = parseInt(currentRow.children[6].textContent.replace('T + ', '')) || 0; // Lấy ngày giao dịch từ cột thứ 7
            const voidDay = Math.min(transactionDay + 1, maxPostDay); // Ngày void không được quá 1 ngày so với ngày giao dịch và nhỏ hơn hoặc bằng T + 24

            currentRow.children[3].textContent = "voided"; // Cập nhật trạng thái thành voided
            currentRow.children[7].textContent = `T + ${voidDay}`; // Cập nhật ngày voided
            const buttons = currentRow.querySelectorAll('button');
            buttons.forEach(button => {
              button.disabled = true;
              button.style.opacity = 0.5; // Thêm hiệu ứng mờ
              button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
            });

            // Nếu giao dịch gốc là cash, void luôn giao dịch fee liên quan
            if (selectedTransaction.type === 'cash') {
              const feeTransactionId = `F${selectedTransaction.id}`; // ID giao dịch fee liên quan
              const feeRow = document.querySelector(`#row-${feeTransactionId}`);
              if (feeRow) {
                feeRow.children[3].textContent = "voided"; // Cập nhật trạng thái thành voided
                feeRow.children[7].textContent = `T + ${voidDay}`; // Cập nhật ngày voided
                const feeButtons = feeRow.querySelectorAll('button');
                feeButtons.forEach(button => {
                  button.disabled = true;
                  button.style.opacity = 0.5; // Thêm hiệu ứng mờ
                  button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
                });

                // Cập nhật trạng thái của giao dịch fee trong mảng transactions
                const feeTransactionIndex = transactions.findIndex(tx => tx.id === feeTransactionId);
                if (feeTransactionIndex !== -1) {
                  transactions[feeTransactionIndex].status = 'voided'; // Cập nhật trạng thái thành voided
                }
              }
            }
          }

          // Cập nhật trạng thái của giao dịch gốc trong mảng transactions
          const transactionIndex = transactions.findIndex(tx => tx.id === selectedTransaction.id);
          if (transactionIndex !== -1) {
            transactions[transactionIndex].status = 'voided'; // Cập nhật trạng thái thành voided
          }
        }

        // Thêm giao dịch trực tiếp vào bảng
        const newRow = document.createElement('tr');
        newRow.id = `row-${transactionId.replace('T', '')}`;
        newRow.innerHTML = `
          <td>${transactionId}</td>
          <td>${originalTransactionId}</td>
          <td>${transactionType}</td>
          <td>${status}</td>
          <td>${amount}</td>
          <td>${transactionType === 'sale' || transactionType === 'cash' ? 0 : ''}</td>
          <td>${day}</td>
          <td>${dayVoided}</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>
            ${
              transactionType === 'sale' && status === 'new'
                ? `
                  <button class="edit-btn" onclick="voidTransaction('${transactionId}')">Void</button>
                  <button class="edit-btn" onclick="refundTransaction('${transactionId}')">Refund</button>
                `
                : ''
            }
          </td>
        `;
        tableBody.appendChild(newRow);
      }

      // Thêm delimiter vào cuối bảng
      const delimiterRow = document.createElement('tr');
      delimiterRow.innerHTML = `
        <td colspan="11" style="background-color: #f0f0f0; text-align: center;">End cycle ${cycle + 1}</td>
      `;
      tableBody.appendChild(delimiterRow);

      ///Cập nhật ngày post
      const tableRows = document.querySelectorAll('#transaction-table tbody tr'); // Lấy tất cả các hàng trong bảng

      for (let i = lastIndex; i < tableRows.length; i++) { // Sửa điều kiện vòng lặp
        const row = tableRows[i];

        // Kiểm tra nếu hàng là delimiter hoặc không hợp lệ
        const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
        if (cells.length < 5) {
          continue; // Bỏ qua hàng không hợp lệ
        }
        //addLog(cells.length);

        const transactionType = row.children[2].textContent.trim(); // Loại giao dịch
        const status = row.children[3].textContent.trim(); // Trạng thái
        const day = row.children[6].textContent.trim(); // Ngày (cột thứ 7)
        const dayPostCell = row.children[9]; // Cột Ngày Post (cột thứ 10)

        // Chỉ xử lý giao dịch sale hoặc cash có trạng thái new
        if (status === 'new' || status === 'completed') 
        {
          if (transactionType === 'sale') {
            // Tạo giá trị Ngày Post ngẫu nhiên, lớn hơn ngày hiện tại và nhỏ hơn T + 24
            const currentDay = parseInt(day.replace('T + ', '')) || 0; // Lấy giá trị số từ ngày
            const postDay = Math.floor(Math.random() * (maxPostDay - currentDay)) + currentDay + 1; // Ngày Post ngẫu nhiên

            // Cập nhật cột Ngày Post
            dayPostCell.textContent = `T + ${postDay}`;
          } else if (transactionType === 'cash') {
            // Đối với giao dịch cash, Ngày Post bằng đúng ngày giao dịch
            dayPostCell.textContent = day;

            // Tìm giao dịch fee liên quan và cập nhật ngày post
            const feeTransactionId = `F${row.children[0].textContent.trim()}`; // ID giao dịch fee liên quan
            const feeRow = document.querySelector(`#row-${feeTransactionId}`);
            if (feeRow) {
              const feeDayPostCell = feeRow.children[9]; // Cột Ngày Post của fee
              feeDayPostCell.textContent = day; // Ngày Post của fee bằng ngày giao dịch cash
            }
          }
          else if (transactionType === 'payment') {
            // Đối với giao dịch payment, Ngày Post là 1 ngày sau ngày giao dịch
            const currentDay = parseInt(day.replace('T + ', '')) || 0; // Lấy giá trị số từ ngày
            const postDay = currentDay + 1; // Ngày Post là 1 ngày sau ngày giao dịch

            // Cập nhật cột Ngày Post
            dayPostCell.textContent = `T + ${postDay}`;
          }
        }
      }
      //
  
      // Cập nhật transactionIdCounter và dayCounter
      transactionIdCounter += totalTransactions;
      dayCounter += totalTransactions;

      //alert(`${totalTransactions} giao dịch ngẫu nhiên đã được tạo!`);

      // Disable nút sau khi tạo giao dịch
      const createButton = document.getElementById('create-sample-btn');
      createButton.disabled = true;
      createButton.style.opacity = 0.5; // Thêm hiệu ứng mờ
      createButton.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
    } 


    function createRandomTransaction() {
      //let maxTransactions = 20;
      const tableBody = document.querySelector('#transaction-table tbody');
      //const totalTransactions = Math.floor(Math.random() * maxTransactions) + 2; // Số ngẫu nhiên từ 1 đến maxTransactions
      let transactions = []; // Lưu trữ các giao dịch sale và cash để làm ID gốc cho void
      const maxPostDay = cycle === 0 ? 25 : (cycle * 25); // Kiểm tra giá trị của cycle
      buttonClickedCnt++;
      if(buttonClickedCnt > 25){
        buttonClickedCnt = 1; // Reset nếu vượt quá 25 lần nhấn nút "Tạo Giao Dịch Mẫu"
      }

      // Tạo giao dịch mẫu

        const transactionId = `T${transactionIdCounter + lastIndex + 1}`;
        const day = `T + ${dayCounter + buttonClickedCnt + (cycle*25) - 1}`;
        let transactionType, originalTransactionId, status, amount;
        dayVoided = '-';

        const randomType = Math.random(); // Giá trị ngẫu nhiên để quyết định loại giao dịch

        if (randomType < 0.5) {
          // Tạo giao dịch sale
          transactionType = 'sale';
          originalTransactionId = '';
          status = 'new';
          amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
          transactions.push({ id: transactionId, type: transactionType, status }); // Lưu giao dịch để làm ID gốc cho void
        } 
        else if (randomType < 0.8) 
        {
          // Tạo giao dịch cash
          transactionType = 'cash';
          originalTransactionId = '';
          status = 'new';
          amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
          transactions.push({ id: transactionId, type: transactionType, status }); // Lưu giao dịch để làm ID gốc cho void

          // Tạo giao dịch fee liên quan
          const feeTransactionId = `F${transactionId}`; // ID giao dịch fee
          const feeAmount = amount * 0.01; // Tính phí bằng 1% số tiền gốc
          const feeTransaction = {
            id: feeTransactionId,
            type: 'fee',
            status: 'new',
            originalTransactionId: transactionId, // Liên kết với giao dịch cash
            amount: feeAmount
          };
          transactions.push(feeTransaction); // Lưu giao dịch fee

          // Thêm giao dịch fee vào bảng
          const feeRow = document.createElement('tr');
          feeRow.id = `row-${feeTransactionId}`;
          feeRow.innerHTML = `
            <td>${feeTransactionId}</td>
            <td>${transactionId}</td>
            <td>fee</td>
            <td>${feeTransaction.status}</td>
            <td>${feeAmount.toFixed(2)}</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td></td>
          `;
          tableBody.appendChild(feeRow);
        } 
        else if (randomType < 0.9) {
          // Tạo giao dịch payment
          transactionType = 'payment';
          originalTransactionId = '';
          status = 'completed';
          amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
          transactions.push({ id: transactionId, type: transactionType, status }); // Lưu giao dịch payment

          // Rà lại bảng và cập nhật giao dịch theo thứ tự cash, fee, sale
          const tableRows = document.querySelectorAll('#transaction-table tbody tr');
          let remainingPayment = amount; // Số tiền payment còn lại để xử lý


          // Xử lý giao dịch cash và fee
          for (let i = 0; i < tableRows.length; i++) {
            const row = tableRows[i];
            const transactionType = row.children[2].textContent.trim(); // Loại giao dịch
            const status = row.children[3].textContent.trim(); // Trạng thái
            const orgAmountCell = row.children[4]; // Cột Số Tiền gốc
            const updatedAmountCell = row.children[5]; // Cột Số Tiền Cập Nhật
            const paidDayCell = row.children[10]; // Cột Ngày Paid
            let orgAmount = parseFloat(orgAmountCell.textContent) || 0; // Số Tiền Gốc
            let updatedAmount = parseFloat(updatedAmountCell.textContent) || 0; // Số Tiền Cập Nhật

            // Chỉ xử lý các giao dịch fee và cash có trạng thái "new" hoặc "refunded" hoặc "partial"
            if ((transactionType === 'cash' || transactionType === 'fee') &&
                (status === 'new' || status === 'refunded' || status === 'partial')) {
              
              if (remainingPayment >= orgAmount) {
                // Nếu số tiền payment đủ để thanh toán toàn bộ số tiền gốc
                remainingPayment -= orgAmount;
                updatedAmountCell.textContent = '0'; // Đặt số tiền cập nhật về 0
                row.children[3].textContent = 'paid'; // Cập nhật trạng thái thành "paid"
                paidDayCell.textContent = `T + ${dayCounter}`; // Cập nhật ngày paid

                // Thêm giao dịch payment vào bảng
                const newRow = document.createElement('tr');
                newRow.id = `row-${transactionId}`;
                newRow.innerHTML = `
                  <td>${transactionId}</td>
                  <td>${originalTransactionId}</td>
                  <td>${transactionType}</td>
                  <td>${status}</td>
                  <td>${amount}</td>
                  <td>-</td>
                  <td>${`T + ${dayCounter}`}</td>
                  <td>-</td>
                  <td>-</td>
                  <td>-</td>
                  <td>-</td>
                `;
                tableBody.appendChild(newRow);
              } 
              else 
              {
                // Nếu số tiền payment không đủ để thanh toán toàn bộ
                const remainingOrgAmount = orgAmount - remainingPayment; // Số tiền còn lại sau khi trừ payment
                remainingPayment = 0; // Đặt số tiền payment còn lại về 0

                // Cập nhật giao dịch hiện tại
                updatedAmountCell.textContent = remainingOrgAmount.toFixed(2); // Cập nhật số tiền còn lại
                paidDayCell.textContent = `T + ${dayCounter}`; // Cập nhật ngày paid

                // Thêm giao dịch payment vào bảng
                const newRowPayment = document.createElement('tr');
                newRowPayment.id = `row-${transactionId}`;
                newRowPayment.innerHTML = `
                  <td>${transactionId}</td>
                  <td>${originalTransactionId}</td>
                  <td>${transactionType}</td>
                  <td>${status}</td>
                  <td>${amount}</td>
                  <td>-</td>
                  <td>${`T + ${dayCounter}`}</td>
                  <td>-</td>
                  <td>-</td>
                  <td>-</td>
                  <td>-</td>
                `;
                tableBody.appendChild(newRowPayment);

                // Thêm một hàng mới cho giao dịch cash với số tiền còn lại
                const newRow = document.createElement('tr');
                newRow.innerHTML = ` 
                  <td>${row.children[0].textContent}-split</td> <!-- ID mới -->
                  <td>${row.children[1].textContent}</td> <!-- ID Giao Dịch Gốc -->
                  <td>${transactionType}</td> <!-- Loại Giao Dịch -->
                  <td>new</td> <!-- Trạng Thái -->
                  <td>${remainingOrgAmount.toFixed(2)}</td> <!-- Số Tiền Gốc -->
                  <td>-</td> <!-- Số Tiền Cập Nhật -->
                  <td>T + ${dayCounter}</td> <!-- Ngày -->
                  <td>-</td> <!-- Ngày Void -->
                  <td>-</td> <!-- Ngày Refund -->
                  <td>-</td> <!-- Ngày Post -->
                  <td>-</td> <!-- Ngày Paid -->
                `;
                tableBody.appendChild(newRow); // Thêm hàng mới vào bảng
              }

              // Nếu số tiền payment đã hết, thoát khỏi vòng lặp
              if (remainingPayment <= 0) {
                break;
              }
            }
          }
        }
        else 
        {
          for (let i = 0; i < tableRows.length; i++) {
            // Tạo giao dịch void
            const validTransactions = transactions.filter(tx => tx.status === 'new'); // Chỉ lấy các giao dịch sale hoặc cash có trạng thái new
            if (validTransactions.length === 0) {
              continue; // Bỏ qua nếu không có giao dịch hợp lệ
            }
            const selectedTransaction = validTransactions[Math.floor(Math.random() * validTransactions.length)]; // Chọn ngẫu nhiên một giao dịch hợp lệ

            transactionType = 'void';
            originalTransactionId = `<span class="original-void">${selectedTransaction.id}</span>`; // Thêm class màu đỏ
            status = 'voided';
            amount = 0; // Void không có số tiền

            // Cập nhật trạng thái của giao dịch gốc
            const currentRow = document.querySelector(`#row-${selectedTransaction.id.replace('T', '')}`);
            if (currentRow) {
              const transactionDay = parseInt(currentRow.children[6].textContent.replace('T + ', '')) || 0; // Lấy ngày giao dịch từ cột thứ 7
              const voidDay = Math.min(transactionDay + 1, maxPostDay); // Ngày void không được quá 1 ngày so với ngày giao dịch và nhỏ hơn hoặc bằng T + 24

              currentRow.children[3].textContent = "voided"; // Cập nhật trạng thái thành voided
              currentRow.children[7].textContent = `T + ${voidDay}`; // Cập nhật ngày voided
              const buttons = currentRow.querySelectorAll('button');
              buttons.forEach(button => {
                button.disabled = true;
                button.style.opacity = 0.5; // Thêm hiệu ứng mờ
                button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
              });

              // Nếu giao dịch gốc là cash, void luôn giao dịch fee liên quan
              if (selectedTransaction.type === 'cash') {
                const feeTransactionId = `F${selectedTransaction.id}`; // ID giao dịch fee liên quan
                const feeRow = document.querySelector(`#row-${feeTransactionId}`);
                if (feeRow) {
                  feeRow.children[3].textContent = "voided"; // Cập nhật trạng thái thành voided
                  feeRow.children[7].textContent = `T + ${voidDay}`; // Cập nhật ngày voided
                  const feeButtons = feeRow.querySelectorAll('button');
                  feeButtons.forEach(button => {
                    button.disabled = true;
                    button.style.opacity = 0.5; // Thêm hiệu ứng mờ
                    button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
                  });

                  // Cập nhật trạng thái của giao dịch fee trong mảng transactions
                  const feeTransactionIndex = transactions.findIndex(tx => tx.id === feeTransactionId);
                  if (feeTransactionIndex !== -1) {
                    transactions[feeTransactionIndex].status = 'voided'; // Cập nhật trạng thái thành voided
                  }
                }
              }
            }

            // Cập nhật trạng thái của giao dịch gốc trong mảng transactions
            const transactionIndex = transactions.findIndex(tx => tx.id === selectedTransaction.id);
            if (transactionIndex !== -1) {
              transactions[transactionIndex].status = 'voided'; // Cập nhật trạng thái thành voided
            }
          }
        }

        // Thêm giao dịch trực tiếp vào bảng
        const newRow = document.createElement('tr');
        newRow.id = `row-${transactionId.replace('T', '')}`;
        newRow.innerHTML = `
          <td>${transactionId}</td>
          <td>${originalTransactionId}</td>
          <td>${transactionType}</td>
          <td>${status}</td>
          <td>${amount}</td>
          <td>${transactionType === 'sale' || transactionType === 'cash' ? 0 : ''}</td>
          <td>${day}</td>
          <td>${dayVoided}</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>
            ${
              transactionType === 'sale' && status === 'new'
                ? `
                  <button class="edit-btn" onclick="voidTransaction('${transactionId}')">Void</button>
                  <button class="edit-btn" onclick="refundTransaction('${transactionId}')">Refund</button>
                `
                : ''
            }
          </td>
        `;
        tableBody.appendChild(newRow);
      

      // Thêm delimiter vào cuối bảng
      // const delimiterRow = document.createElement('tr');
      // delimiterRow.innerHTML = `
      //   <td colspan="11" style="background-color: #f0f0f0; text-align: center;">End cycle ${cycle + 1}</td>
      // `;
      // tableBody.appendChild(delimiterRow);

      ///Cập nhật ngày post
      const tableRows = document.querySelectorAll('#transaction-table tbody tr'); // Lấy tất cả các hàng trong bảng

      for (let i = lastIndex; i < tableRows.length; i++) { // Sửa điều kiện vòng lặp
        const row = tableRows[i];

        // Kiểm tra nếu hàng là delimiter hoặc không hợp lệ
        const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
        if (cells.length < 5) {
          continue; // Bỏ qua hàng không hợp lệ
        }
        //addLog(cells.length);

        const transactionType = row.children[2].textContent.trim(); // Loại giao dịch
        const status = row.children[3].textContent.trim(); // Trạng thái
        const day = row.children[6].textContent.trim(); // Ngày (cột thứ 7)
        const dayPostCell = row.children[9]; // Cột Ngày Post (cột thứ 10)

        // Chỉ xử lý giao dịch sale hoặc cash có trạng thái new
        if (status === 'new' || status === 'completed') 
        {
          if (transactionType === 'sale') {
            // Tạo giá trị Ngày Post ngẫu nhiên, lớn hơn ngày hiện tại và nhỏ hơn T + 24
            const currentDay = parseInt(day.replace('T + ', '')) || 0; // Lấy giá trị số từ ngày
            const postDay = Math.floor(Math.random() * (maxPostDay - currentDay)) + currentDay + 1; // Ngày Post ngẫu nhiên

            // Cập nhật cột Ngày Post
            dayPostCell.textContent = `T + ${postDay}`;
          } else if (transactionType === 'cash') {
            // Đối với giao dịch cash, Ngày Post bằng đúng ngày giao dịch
            dayPostCell.textContent = day;

            // Tìm giao dịch fee liên quan và cập nhật ngày post
            const feeTransactionId = `F${row.children[0].textContent.trim()}`; // ID giao dịch fee liên quan
            const feeRow = document.querySelector(`#row-${feeTransactionId}`);
            if (feeRow) {
              const feeDayPostCell = feeRow.children[9]; // Cột Ngày Post của fee
              feeDayPostCell.textContent = day; // Ngày Post của fee bằng ngày giao dịch cash
            }
          }
          else if (transactionType === 'payment') {
            // Đối với giao dịch payment, Ngày Post là 1 ngày sau ngày giao dịch
            const currentDay = parseInt(day.replace('T + ', '')) || 0; // Lấy giá trị số từ ngày
            const postDay = currentDay + 1; // Ngày Post là 1 ngày sau ngày giao dịch

            // Cập nhật cột Ngày Post
            dayPostCell.textContent = `T + ${postDay}`;
          }
        }
      }
      //
  
      // Cập nhật transactionIdCounter và dayCounter
      transactionIdCounter += 1;
      dayCounter += 1;

      //alert(`${totalTransactions} giao dịch ngẫu nhiên đã được tạo!`);

      // Disable nút sau khi tạo giao dịch
      // const createButton = document.getElementById('create-sample-btn');
      // createButton.disabled = true;
      // createButton.style.opacity = 0.5; // Thêm hiệu ứng mờ
      // createButton.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
    }
    
    

    
    


    function createSampleTransactions_2() {
      const tableBody = document.querySelector('#transaction-table tbody');
      const totalTransactions = 25; // Tổng số giao dịch cần tạo
      let saleTransactions = []; // Lưu trữ các giao dịch sale để làm ID gốc cho void và refund

      // Tạo giao dịch mẫu
      for (let i = 1; i <= totalTransactions; i++) {
        const transactionId = `T${transactionIdCounter + i}`;
        const day = `T + ${dayCounter + i - 1}`;
        let transactionType, originalTransactionId, status, amount;
        dayVoided = '-';
        dayRefunded = '-';


        if (i <= 15) {
          // Tạo 15 giao dịch sale
          transactionType = 'sale';
          originalTransactionId = '';
          status = 'new';
          amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
          saleTransactions.push({ id: transactionId, status }); // Lưu ID và trạng thái giao dịch sale
        } else if (i <= 20) {
          // Tạo 5 giao dịch void
          const validSales = saleTransactions.filter(sale => sale.status === 'new'); // Chỉ lấy các giao dịch sale có trạng thái new
          if (validSales.length === 0) {
            //alert('Không có giao dịch sale nào với trạng thái new để tạo void!');
            break; // Thoát khỏi vòng lặp nếu không có giao dịch hợp lệ
          }
          const selectedSale = validSales[Math.floor(Math.random() * validSales.length)]; // Chọn ngẫu nhiên một giao dịch hợp lệ

          // Kiểm tra nếu giao dịch đã được refund thì không cho void
          const currentRow = document.querySelector(`#row-${selectedSale.id.replace('T', '')}`);
          if (currentRow && currentRow.children[3].textContent === 'refunded') {
            //alert(`Giao dịch ${selectedSale.id} đã được refund, không thể tạo void!`);
            continue; // Bỏ qua giao dịch này
          }

          transactionType = 'void';
          // originalTransactionId = selectedSale.id; // Lấy ID gốc từ giao dịch sale hợp lệ
          originalTransactionId = `<span class="original-void">${selectedSale.id}</span>`; // Thêm class màu đỏ
          //dayVoided = currentRow.children[6].textContent; // Ngày lấy từ gd sale
          status = 'voided';
          //amount = 0; // Void không có số tiền

          // Lấy số tiền từ giao dịch sale gốc
          const saleAmount = parseInt(currentRow.children[4].textContent) || 0; // Cột thứ 5 chứa số tiền gốc
          amount = saleAmount; // Gán số tiền từ giao dịch sale gốc cho giao dịch void

          // Cập nhật trạng thái của giao dịch sale gốc
          if (currentRow) {
            currentRow.children[3].textContent = "voided"; // Cập nhật trạng thái thành voided
            currentRow.children[7].textContent = day; // Cập nhật ngày voided
            const buttons = currentRow.querySelectorAll('button');
            buttons.forEach(button => {
              button.disabled = true;
              button.style.opacity = 0.5; // Thêm hiệu ứng mờ
              button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
            });
          }

          // Cập nhật trạng thái của giao dịch sale gốc trong mảng saleTransactions
          const saleIndex = saleTransactions.findIndex(sale => sale.id === selectedSale.id);
          if (saleIndex !== -1) {
            saleTransactions[saleIndex].status = 'voided'; // Cập nhật trạng thái thành voided
          }
        } else {
          // Tạo 5 giao dịch refund
          const validSales = saleTransactions.filter(sale => sale.status === 'new'); // Chỉ lấy các giao dịch sale có trạng thái new
          if (validSales.length === 0) {
            //alert('Không có giao dịch sale nào với trạng thái new để tạo refund!');
            break; // Thoát khỏi vòng lặp nếu không có giao dịch hợp lệ
          }
          const selectedSale = validSales[Math.floor(Math.random() * validSales.length)]; // Chọn ngẫu nhiên một giao dịch hợp lệ

          // Kiểm tra nếu giao dịch đã được voided thì không cho refund
          const currentRow = document.querySelector(`#row-${selectedSale.id.replace('T', '')}`);
          if (currentRow && currentRow.children[3].textContent === 'voided') {
            //alert(`Giao dịch ${selectedSale.id} đã được voided, không thể tạo refund!`);
            continue; // Bỏ qua giao dịch này
          }

          transactionType = 'refund';
          // originalTransactionId = selectedSale.id; // Lấy ID gốc từ giao dịch sale hợp lệ
          originalTransactionId = `<span class="original-refund">${selectedSale.id}</span>`; // Thêm class màu xanh
          //dayRefunded = currentRow.children[6].textContent; // Ngày lấy từ gd sale
          status = 'refunded';
          //amount = Math.floor(Math.random() * 5 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000

          // Lấy số tiền từ giao dịch sale gốc
          const saleAmount = parseInt(currentRow.children[4].textContent) || 0; // Cột thứ 5 chứa số tiền gốc

          // Tạo số tiền refund ngẫu nhiên, đảm bảo nhỏ hơn hoặc bằng số tiền gốc
          amount = Math.min(Math.floor(Math.random() * 5 + 1) * 1000, saleAmount); // Số tiền refund không vượt quá số tiền gốc

          // Cập nhật trạng thái của giao dịch sale gốc
          if (currentRow) {
            currentRow.children[3].textContent = "refunded"; // Cập nhật trạng thái thành refunded
            currentRow.children[8].textContent = day; // Cập nhật ngày refunded

            // Lấy số tiền gốc và số tiền cập nhật hiện tại
            const originalAmount = parseInt(currentRow.children[4].textContent) || 0; // Số tiền gốc (cột thứ 5)
            const updatedAmount = parseInt(currentRow.children[5].textContent) || originalAmount; // Số tiền cập nhật (cột thứ 6)

            // Tính số tiền còn lại sau khi refund
            const remainingAmount = updatedAmount - amount;

            // Cập nhật cột Số Tiền Cập Nhật
            currentRow.children[5].textContent = remainingAmount.toFixed(2);

            // Vô hiệu hóa các nút trong cột Hành Động
            const buttons = currentRow.querySelectorAll('button');
            buttons.forEach(button => {
              button.disabled = true;
              button.style.opacity = 0.5; // Thêm hiệu ứng mờ
              button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
            });
          }

          // Cập nhật trạng thái của giao dịch sale gốc trong mảng saleTransactions
          const saleIndex = saleTransactions.findIndex(sale => sale.id === selectedSale.id);
          if (saleIndex !== -1) {
            saleTransactions[saleIndex].status = 'refunded'; // Cập nhật trạng thái thành refunded
          }
        }

        // Thêm giao dịch trực tiếp vào bảng
        const newRow = document.createElement('tr');
        newRow.id = `row-${transactionId.replace('T', '')}`;
        newRow.innerHTML = `
          <td>${transactionId}</td>
          <td>${originalTransactionId}</td>
          <td>${transactionType}</td>
          <td>${status}</td>
          <td>${amount}</td>
          <td>${transactionType === 'sale' ? 0 : ''}</td>
          <td>${day}</td>
          <td>${dayVoided}</td>
          <td>${dayRefunded}</td>
          <td>
            ${
              transactionType === 'sale' && status === 'new'
                ? `
                  <button class="edit-btn" onclick="voidTransaction('${transactionId}')">Void</button>
                  <button class="edit-btn" onclick="refundTransaction('${transactionId}')">Refund</button>
                `
                : ''
            }
          </td>
        `;
        tableBody.appendChild(newRow);
      }

      // Cập nhật transactionIdCounter và dayCounter
      transactionIdCounter += totalTransactions;
      dayCounter += totalTransactions;

      //alert('25 giao dịch mẫu đã được tạo!');
    }


    ///////////// Phần tính toán cho phần bucket
    let bucketIdCounter = 1; // Biến đếm ID tự tăng cho bucket

    function addToBucketList(description, minPayment) {
      const tableBody = document.querySelector('#bucket-list-table tbody');

      // Vô hiệu hóa các nút trong các hàng trước đó
      const previousRows = tableBody.querySelectorAll('tr');
      previousRows.forEach(row => {
        const buttons = row.querySelectorAll('button');
        buttons.forEach(button => {
          button.disabled = true; // Vô hiệu hóa nút
          button.style.opacity = 0.5; // Thêm hiệu ứng mờ
          button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
        });
      });

      // Tạo ID tự sinh
      const bucketId = `B${bucketIdCounter++}`;

      // Tạo một hàng mới
      const newRow = document.createElement('tr');
      newRow.id = `row-${bucketId}`;
      newRow.innerHTML = `
        <td>${bucketId}</td>
        <td>${description}</td>
        <td>${minPayment}</td>
        <td>
          <input type="text" id="amount-${bucketId}" value="0" style="width: 100px;" />
        </td>
        <td>
          <input type="text" id="pay-date-${bucketId}" value="0" style="width: 100px;" />
        </td>
        <td>
          <button onclick="payFull('${bucketId}')" class="edit-btn" style="margin-bottom: 5px;">Thanh toán toàn bộ</button>
          <br>
          <button onclick="payMin('${bucketId}')" class="edit-btn" style="margin-bottom: 5px;">Thanh toán tối thiểu</button>
          <br>
          <button onclick="payPartial('${bucketId}')" class="edit-btn" style="margin-bottom: 5px;">Thanh toán một phần</button>
          <br>
          <button onclick="nopay('${bucketId}')" class="edit-btn" style="margin-bottom: 5px;">Không trả</button>
        </td>
      `;

      // Thêm hàng mới vào bảng
      tableBody.appendChild(newRow);
    }

    // Hàm xử lý thanh toán toàn bộ
    function payFull(bucketId) 
    {
      const amountInput = document.getElementById(`amount-${bucketId}`);
      const payDateInput = document.getElementById(`pay-date-${bucketId}`); // Lấy textbox chứa ngày thanh toán
      const row = document.getElementById(`row-${bucketId}`); // Lấy hàng tương ứng trong bảng bucket-list-table
      const descriptionCell = row.querySelector('td:nth-child(2)'); // Cột chứa description
      let sumValue = 0; // Biến lưu giá trị Sum

      if (descriptionCell) {
          const descriptionText = descriptionCell.innerHTML; // Lấy nội dung của description

          // Trích xuất giá trị Sum từ description
          const sumMatch = descriptionText.match(/Sum: ([\d.]+)/);
          sumValue = sumMatch ? parseFloat(sumMatch[1]) : 0;

          // Lấy giá trị ngày thanh toán từ textbox
          const paidDay = payDateInput ? payDateInput.value.trim() : 'N/A'; // Nếu không có giá trị, đặt là 'N/A'

          // Cập nhật Payment trong description
          let updatedDescription = descriptionText.replace(/Payment: [\d.]+/, `Paid: ${sumValue.toFixed(2)}`);

          // Tính toán giá trị Remain
          const remainValue = sumValue - sumValue;

          // Cập nhật hoặc thêm giá trị Remain vào description
          if (updatedDescription.includes('Remain:')) {
            updatedDescription = updatedDescription.replace(
              /Remain: .*/,
              `Remain: ${sumValue.toFixed(2)} - ${sumValue.toFixed(2)} = <span style="color: red;">${remainValue.toFixed(2)}</span>`
            );
          } else {
            updatedDescription += `<br>Remain: ${sumValue.toFixed(2)} - ${sumValue.toFixed(2)} = <span style="color: red;">${remainValue.toFixed(2)}</span>`;
          }

          // Thêm PaidDay vào description
          if (updatedDescription.includes('PaidDay:')) {
            updatedDescription = updatedDescription.replace(
              /PaidDay: .*/,
              `PaidDay: <span style="color: red;">T + ${cycle * 25 + parseInt(paidDay, 10)}</span>`
            );
          } else {
            updatedDescription += `<br>PaidDay: <span style="color: red;">T + ${cycle * 25 + parseInt(paidDay, 10)}</span>`;
          }

          // Thêm status: Full vào description
          if (!updatedDescription.includes('Status: Full')) {
            updatedDescription += `<br>Status: <span style="color: red;">Full</span>`;
          }

          descriptionCell.innerHTML = updatedDescription; // Cập nhật nội dung của description
      }

      amountInput.value = 0; // Đặt số tiền về 0 sau khi thanh toán

      // Vô hiệu hóa tất cả các nút trong hàng hiện tại
      const tableRows = document.querySelectorAll('#bucket-list-table tbody tr');
      tableRows.forEach(tableRow => {
        if (tableRow.id == `row-${bucketId}`) { // Kiểm tra là hàng hiện tại
          const previousButtons = tableRow.querySelectorAll('button');
          previousButtons.forEach(button => {
            button.disabled = true; // Vô hiệu hóa nút
            button.style.opacity = 0.5; // Thêm hiệu ứng mờ
            button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
          });
        }
      });
      calInterestForFee = false;
      calInterestForSale = false;
      addLog(`Thanh toán toàn bộ cho cycle ${cycle} với số tiền: ${sumValue.toFixed(2)}`); // Ghi log thanh toán
      addLineInLog();
      const calculateButton = document.getElementById('cal-statement');
      calculateButton.disabled = false; // Kích hoạt nút tính toán sau khi thanh toán toàn bộ
      payAction = 1;
      updateStatusStatement();
      
    }

    // Hàm xử lý thanh toán tối thiểu
    function payMin(bucketId) {
      const amountInput = document.getElementById(`amount-${bucketId}`);
      const row = document.getElementById(`row-${bucketId}`); // Lấy hàng tương ứng trong bảng bucket-list-table
      const descriptionCell = row.querySelector('td:nth-child(2)'); // Cột chứa description
      const minPaymentCell = row.querySelector('td:nth-child(3)'); // Cột thứ 3 chứa số tiền thanh toán tối thiểu
      let sumValue = 0; // Biến lưu giá trị Sum
      let paymentValue = 0; // Biến lưu giá trị Payment
      let minAmount = 0; // Biến lưu giá trị thanh toán tối thiểu

      if (minPaymentCell) {
        // Lấy số tiền thanh toán tối thiểu từ cột thứ 3
          minAmount = parseFloat(minPaymentCell.textContent) || 0;
      }

      if (descriptionCell) 
      {
          const descriptionText = descriptionCell.innerHTML; // Lấy nội dung của description
          //addLog(`Nội dung description: ${descriptionText}`); // Ghi log nội dung description

          // Trích xuất giá trị Sum từ description
          const sumMatch = descriptionText.match(/Sum: <span style="color: red;">([\d.]+)<\/span>/);
          addLog(`Trích xuất giá trị Sum: ${sumMatch ? sumMatch[1] : 'Không tìm thấy'}`); // Ghi log giá trị Sum
          sumValue = sumMatch ? parseFloat(sumMatch[1]) : 0;

          // Trích xuất giá trị Payment từ description
          const paymentMatch = descriptionText.match(/Paid: ([\d.]+)/);
          paymentValue = paymentMatch ? parseFloat(paymentMatch[1]) : 0;

          // Cập nhật Payment trong description
          const newPaymentValue = paymentValue + minAmount;
          let updatedDescription = descriptionText.replace(/Payment: [\d.]+/, `Paid: ${newPaymentValue.toFixed(2)}`);

          createTransactionPaymentWhenCalStatement(minAmount); // Tạo giao dịch thanh toán            
          // Tính toán giá trị Remain
          const remainValue = sumValue - newPaymentValue;

          //addLog(`Thanh toán tối thiểu cho cycle ${cycle} với số tiền: ${minAmount.toFixed(2)} với sum: ${sumValue.toFixed(2)}`); // Ghi log thanh toán
          // Cập nhật hoặc thêm giá trị Remain vào description
          if (updatedDescription.includes('Remain:')) {
            updatedDescription = updatedDescription.replace(
              /Remain: [\d.]+/,
              `Remain:  ${sumValue.toFixed(2)} - ${newPaymentValue.toFixed(2)} = ${remainValue.toFixed(2)}`
            );
          } 
          else 
          {
            updatedDescription += `<br>Remain: ${sumValue.toFixed(2)} - ${newPaymentValue.toFixed(2)} = ${remainValue.toFixed(2)}`;
          }

          // Thêm status: Partial vào description
          if (!updatedDescription.includes('Status: Partial')) 
          {
            updatedDescription += `<br>Status: Partial`;
          }

          descriptionCell.innerHTML = updatedDescription; // Cập nhật nội dung của description
      }

      // Cập nhật số tiền còn lại trong ô input
      amountInput.value = (parseFloat(amountInput.value) - minAmount).toFixed(2);

      // Vô hiệu hóa tất cả các nút trong hàng hiện tại
      const tableRows = document.querySelectorAll('#bucket-list-table tbody tr');
      tableRows.forEach(tableRow => {
        if (tableRow.id == `row-${bucketId}`) { // Kiểm tra là hàng hiện tại
          const previousButtons = tableRow.querySelectorAll('button');
          previousButtons.forEach(button => {
            button.disabled = true; // Vô hiệu hóa nút
            button.style.opacity = 0.5; // Thêm hiệu ứng mờ
            button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
          });
        }
      });
      calInterestForFee = true;
      calInterestForSale = true;
      //alert(`Thanh toán tối thiểu số tiền: ${minAmount.toFixed(2)}`);
      addLog(`Thanh toán tối thiểu cho cycle ${cycle} với số tiền: ${minAmount.toFixed(2)}`);
      addLineInLog();
      const calculateButton = document.getElementById('cal-statement');
      calculateButton.disabled = false; // Kích hoạt nút tính toán sau khi thanh toán toàn bộ
      payAction = 2;
      updateStatusStatement();
    }

    // Hàm xử lý thanh toán một phần
    function payPartial(bucketId) {
      const amountInput = document.getElementById(`amount-${bucketId}`);
      const partialAmount = prompt('Nhập số tiền muốn thanh toán:');
      if (partialAmount && !isNaN(partialAmount)) {
        const remainingAmount = parseFloat(amountInput.value) - parseFloat(partialAmount);
        if (remainingAmount < 0) {
          alert('Số tiền thanh toán vượt quá số tiền hiện tại!');
        } else {
          alert(`Thanh toán một phần số tiền: ${parseFloat(partialAmount).toFixed(2)}`);
          amountInput.value = remainingAmount.toFixed(2); // Cập nhật số tiền còn lại
        }
      } else {
        alert('Vui lòng nhập số tiền hợp lệ!');
      }
      addLog(`Thanh toán một phần cho cycle ${cycle} với số tiền: ${partialAmount}`);
      addLineInLog();
      calInterestForFee = true;
      calInterestForSale = true;
      const calculateButton = document.getElementById('cal-statement');
      calculateButton.disabled = false; // Kích hoạt nút tính toán sau khi thanh toán toàn bộ
      const row = document.getElementById(`row-${bucketId}`); // Lấy hàng tương ứng trong bảng bucket-list-table
      const descriptionCell = row.querySelector('td:nth-child(2)'); // Cột chứa description
      const minPaymentCell = row.querySelector('td:nth-child(3)'); // Cột thứ 3 chứa số tiền thanh toán tối thiểu
      let minAmount = parseFloat(minPaymentCell.textContent);
      if(partialAmount > minAmount) 
        payAction = 3;
      else
        payAction = 4;
      updateStatusStatement();
    }

    function nopay(bucketId) {
      addLog(`Không thanh toán cho kỳ sao kê ${cycle}`);
      addLineInLog();
      calInterestForFee = true;
      calInterestForSale = true;
      const calculateButton = document.getElementById('cal-statement');
      calculateButton.disabled = false; // Kích hoạt nút tính toán sau khi thanh toán toàn bộ
      payAction = 5; // Đặt hành động là không thanh toán
      updateStatusStatement();
    }


    function enableCreateSampleButton() {
      const createButton = document.getElementById('create-sample-btn'); // Lấy nút bằng ID
      if (createButton) {
        createButton.disabled = false; // Bật lại nút
        createButton.style.opacity = 1; // Xóa hiệu ứng mờ
        createButton.style.cursor = 'pointer'; // Đổi con trỏ chuột về trạng thái bình thường
      }
    }

    // Hàm reset bảng giao dịch
    function resetTransactionTable() {
      const tableBody = document.querySelector('#transaction-table tbody'); // Lấy phần thân của bảng giao dịch
      if (tableBody) {
        tableBody.innerHTML = ''; // Xóa toàn bộ nội dung trong bảng
      }

      // Đặt lại các biến liên quan
      transactionIdCounter = 0; // Đặt lại bộ đếm ID giao dịch
      dayCounter = 0; // Đặt lại bộ đếm ngày
      lastIndex = 0; // Đặt lại chỉ số cuối cùng
      buttonClickedCnt = 0; // Đặt lại bộ đếm số lần nhấn nút "Tạo Giao Dịch Mẫu"

      // Hiển thị thông báo
      //alert('Bảng giao dịch đã được reset!');

      enableCreateSampleButton();
      const logContainer = document.getElementById('log-container'); // Lấy khu vực log bằng ID
      if (logContainer) {
        logContainer.innerHTML = ''; // Xóa toàn bộ nội dung trong khu vực log
      }
    }

    function resetLog() {
      const logContainer = document.getElementById('log-container'); // Lấy khu vực log bằng ID
      if (logContainer) {
        logContainer.innerHTML = ''; // Xóa toàn bộ nội dung trong khu vực log
      }
    }

    ///////////////////

    function createRandomTransactionSale() {
      //let maxTransactions = 20;
      const tableBody = document.querySelector('#transaction-table tbody');
      //const totalTransactions = Math.floor(Math.random() * maxTransactions) + 2; // Số ngẫu nhiên từ 1 đến maxTransactions
      let transactions = []; // Lưu trữ các giao dịch sale và cash để làm ID gốc cho void
      const maxPostDay = cycle === 0 ? 25 : (cycle * 25) + 25; // Kiểm tra giá trị của cycle
      buttonClickedCnt++;
      if(buttonClickedCnt > 25){
        buttonClickedCnt = 1; // Reset nếu vượt quá 25 lần nhấn nút "Tạo Giao Dịch Mẫu"
      }
      let statusPaidSale = 'new'; // Trạng thái của giao dịch sale mới

      // Tạo giao dịch mẫu

      const transactionId = `T${dayCounter + 1}`;
      let day = '';
      //addLog(`dayCounter: ${dayCounter}, cycle: ${cycle}, buttonClickedCnt: ${buttonClickedCnt}, maxPostDay: ${maxPostDay}`);

      // if(cycle === 0)
      // {
      //   if((dayCounter) < maxPostDay - 1)
      //   {
      //     day = `T + ${dayCounter  + (cycle*25)}`;
      //   }
      //   else
      //   {
      //     alert(`Không thể tạo giao dịch mới vì đã đạt đến giới hạn ngày post tối đa (T + ${maxPostDay}). Vui lòng tạo giao dịch mới sau khi reset.`);
      //     addDelimiterRow();
      //     return;
      //   }
      // }
      // else
      // {
        if((dayCounter) < maxPostDay - 1)
        {
          day = `T + ${dayCounter}`;
        }
        else
        {
          alert(`Không thể tạo giao dịch mới vì đã đạt đến giới hạn ngày post tối đa (T + ${maxPostDay}). Vui lòng tạo giao dịch mới sau khi reset.`);
          addDelimiterRow();
          return;
        }
      //}

      let transactionType, originalTransactionId, status, amount;
      dayVoided = '-';

      const randomType = Math.random(); // Giá trị ngẫu nhiên để quyết định loại giao dịch

      // Tạo giao dịch sale
      transactionType = 'sale';
      originalTransactionId = '';

      amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
      addLog(`Số tiền thực tế: ${amount}`);
      if(amount > amountPaymentInCycle)
      {
          addLog(`Số tiền giao dịch (${amount}) vượt quá số tiền thanh toán còn lại (${amountPaymentInCycle})`);
          amount = amount - amountPaymentInCycle;
          amountPaymentInCycle = 0;
          updateLabelAmtPaymentInCycle();
      }
      else
      {
          addLog(`Số tiền giao dịch (${amount}) không vượt quá số tiền thanh toán còn lại (${amountPaymentInCycle})`);
          amountPaymentInCycle = amountPaymentInCycle - amount;
          amount = 0;
          updateLabelAmtPaymentInCycle();
          statusPaidSale = 'paid';
      }
      transactions.push({ id: transactionId, type: transactionType, status }); // Lưu giao dịch để làm ID gốc cho void
      status = statusPaidSale;
      // Thêm giao dịch trực tiếp vào bảng
      addLog(`Thêm giao dịch: ${transactionId}, Ngày: ${day}, Loại: ${transactionType}, Số tiền thực tế: ${amount}`);
      const newRow = document.createElement('tr');
      newRow.id = `row-${transactionId.replace('T', '')}`;
      newRow.innerHTML = `
        <td>${transactionId}</td>
        <td>${originalTransactionId}</td>
        <td>${transactionType}</td>
        <td>${status}</td>
        <td>${amount}</td>
        <td>${transactionType === 'sale' || transactionType === 'cash' ? 0 : ''}</td>
        <td>${day}</td>
        <td>${dayVoided}</td>
        <td>-</td>
        <td>T + ${parseInt(day.replace('T + ', '')) + 1}</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>
          ${
            transactionType === 'sale' && status === 'asdsadas'
              ? `
                <button class="edit-btn" onclick="voidTransaction('${transactionId}')">Void</button>
                <button class="edit-btn" onclick="refundTransaction('${transactionId}')">Refund</button>
              `
              : '-'
          }
        </td>
      `;
      tableBody.appendChild(newRow);
      

      ///Cập nhật ngày post
      // const tableRows = document.querySelectorAll('#transaction-table tbody tr'); // Lấy tất cả các hàng trong bảng

      // for (let i = lastIndex; i < tableRows.length; i++) 
      // { // Sửa điều kiện vòng lặp
      //   const row = tableRows[i];

      //   // Kiểm tra nếu hàng là delimiter hoặc không hợp lệ
      //   const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
      //   if (cells.length < 5) {
      //     continue; // Bỏ qua hàng không hợp lệ
      //   }
      //   //addLog(cells.length);

      //   const transactionType = row.children[2].textContent.trim(); // Loại giao dịch
      //   const status = row.children[3].textContent.trim(); // Trạng thái
      //   const day = row.children[6].textContent.trim(); // Ngày (cột thứ 7)
      //   const dayPostCell = row.children[9]; // Cột Ngày Post (cột thứ 10)

      //   // Chỉ xử lý giao dịch sale hoặc cash có trạng thái new
      //   if (status === 'new') 
      //   {
      //     if (transactionType === 'sale') {
      //       // Tạo giá trị Ngày Post ngẫu nhiên, lớn hơn ngày hiện tại và nhỏ hơn T + 24
      //       const currentDay = parseInt(day.replace('T + ', '')) || 0; // Lấy giá trị số từ ngày
      //       let postDay;

      //       // Kiểm tra nếu maxPostDay lớn hơn currentDay + 1
      //       if (maxPostDay > currentDay + 1) {
      //         //postDay = Math.floor(Math.random() * (maxPostDay - currentDay - 1)) + currentDay + 1; // Ngày Post ngẫu nhiên
      //         postDay = currentDay + 1; // ngày post là ngày tiếp theo
      //       } else {
      //         postDay = currentDay + 1; // Nếu không, đặt ngày post là ngày tiếp theo
      //       }
      //       // Cập nhật cột Ngày Post
      //       dayPostCell.textContent = `T + ${postDay}`;
      //     } 
      //     else if (transactionType === 'cash') 
      //     {
      //       // Đối với giao dịch cash, Ngày Post bằng đúng ngày giao dịch
      //       dayPostCell.textContent = day;

      //       // Tìm giao dịch fee liên quan và cập nhật ngày post
      //       const feeTransactionId = `F${row.children[0].textContent.trim()}`; // ID giao dịch fee liên quan
      //       const feeRow = document.querySelector(`#row-${feeTransactionId}`);
      //       if (feeRow) {
      //         const feeDayPostCell = feeRow.children[9]; // Cột Ngày Post của fee
      //         feeDayPostCell.textContent = day; // Ngày Post của fee bằng ngày giao dịch cash
      //       }
      //     }
      //     else if (transactionType === 'payment') {
      //       // Đối với giao dịch payment, Ngày Post là 1 ngày sau ngày giao dịch
      //       const currentDay = parseInt(day.replace('T + ', '')) || 0; // Lấy giá trị số từ ngày
      //       const postDay = currentDay + 1; // Ngày Post là 1 ngày sau ngày giao dịch

      //       // Cập nhật cột Ngày Post
      //       dayPostCell.textContent = `T + ${postDay}`;
      //     }
      //   }
      // }
      //
  
      // Cập nhật transactionIdCounter và dayCounter
      transactionIdCounter += 1;
      dayCounter += 1;
      addLineInLog();
    }

    function createRandomTransactionCash() {
      //let maxTransactions = 20;
      const tableBody = document.querySelector('#transaction-table tbody');
      //const totalTransactions = Math.floor(Math.random() * maxTransactions) + 2; // Số ngẫu nhiên từ 1 đến maxTransactions
      let transactions = []; // Lưu trữ các giao dịch sale và cash để làm ID gốc cho void
      const maxPostDay = cycle === 0 ? 25 : (cycle * 25) + 25; // Kiểm tra giá trị của cycle
      let orgAmountCash = 0;
      buttonClickedCnt++;
      if(buttonClickedCnt > 25){
        buttonClickedCnt = 1; // Reset nếu vượt quá 25 lần nhấn nút "Tạo Giao Dịch Mẫu"
      }
      let statusPaidCash = 'new'; // Trạng thái của giao dịch cash
      let statusPaidFee = 'new'; // Trạng thái của giao dịch fee

      // Tạo giao dịch mẫu

        const transactionId = `T${dayCounter + 1}`;
        let day = '';
        //addLog(`dayCounter: ${dayCounter}, cycle: ${cycle}, buttonClickedCnt: ${buttonClickedCnt}, maxPostDay: ${maxPostDay}`);

        // if(cycle === 0)
        // {
        //   if((dayCounter) < maxPostDay - 1)
        //   {
        //     day = `T + ${dayCounter  + (cycle*25)}`;
        //   }
        //   else
        //   {
        //     alert(`Không thể tạo giao dịch mới vì đã đạt đến giới hạn ngày post tối đa (T + ${maxPostDay}). Vui lòng tạo giao dịch mới sau khi reset.`);
        //     addDelimiterRow();
        //     return;
        //   }
        // }
        // else
        // {
          if((dayCounter) < maxPostDay - 1)
          {
            day = `T + ${dayCounter}`;
          }
          else
          {
            alert(`Không thể tạo giao dịch mới vì đã đạt đến giới hạn ngày post tối đa (T + ${maxPostDay}). Vui lòng tạo giao dịch mới sau khi reset.`);
            addDelimiterRow();
            return;
          }
        //}

        let transactionType, originalTransactionId, status, amount;
        dayVoided = '-';

        const randomType = Math.random(); // Giá trị ngẫu nhiên để quyết định loại giao dịch
        // Tạo giao dịch cash
        addLog(`Tạo giao dịch: ${transactionId}, Ngày: ${day}, Loại: cash`);
        transactionType = 'cash';
        originalTransactionId = '';
        status = 'new';
        amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
        orgAmountCash = amount; // Lưu số tiền gốc để tính phí sau này
        let feeAmount = orgAmountCash * 0.04; // Tính phí bằng 4% số tiền gốc
        addLog(`amount cash xài thực tế: ${amount}`);
        if(amount > amountPaymentInCycle)
        {
            amount = amount - amountPaymentInCycle;
            addLog(`amount cash lớn hơn số tiền còn lại (${amountPaymentInCycle})`);
            amountPaymentInCycle = 0; // Reset số tiền còn lại
        }
        else
        {
            addLog(`amount cash nhỏ hơn số tiền còn lại (${amountPaymentInCycle})`);
            amountPaymentInCycle = amountPaymentInCycle - amount; // Reset số tiền còn lại
            amount = 0;
            statusPaidCash = 'paid'; // Đặt trạng thái là paid nếu số tiền cash nhỏ hơn số tiền còn lại
            if(feeAmount > amountPaymentInCycle) //so thêm với số tiền fee
            {
                amountPaymentInCycle = 0; // Reset số tiền còn lại nếu phí lớn hơn số tiền còn lại
                feeAmount = feeAmount - amountPaymentInCycle;
            }
            else
            {
                amountPaymentInCycle = amountPaymentInCycle - feeAmount;
                feeAmount = 0;
                statusPaidFee = 'paid';
            }
        }

        updateLabelAmtPaymentInCycle();
        addLog(`amount cash sau khi so với số tiền thanh toán còn lại: ${amount}`);
        transactions.push({ id: transactionId, type: transactionType, status }); // Lưu giao dịch để làm ID gốc cho void

        // Tạo giao dịch fee liên quan
        const feeTransactionId = `F${transactionId}`; // ID giao dịch fee

        const feeTransaction = {
          id: feeTransactionId,
          type: 'fee',
          status: statusPaidFee,
          originalTransactionId: transactionId, // Liên kết với giao dịch cash
          amount: feeAmount
        };
        transactions.push(feeTransaction); // Lưu giao dịch fee

        // Thêm giao dịch fee vào bảng
        const feeRow = document.createElement('tr');
        feeRow.id = `row-${feeTransactionId}`;
        feeRow.innerHTML = `
          <td>${feeTransactionId}</td>
          <td><span class="original-void">${transactionId}</span></td>
          <td>fee</td>
          <td>${feeTransaction.status}</td>
          <td>${feeAmount.toFixed(2)}</td>
          <td>-</td>
          <td>${day}</td> 
          <td>-</td>
          <td>-</td>
          <td>${day}</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
        `;
        tableBody.appendChild(feeRow);
        addLog(`Tạo giao dịch fee: ${feeTransactionId}, Ngày: ${day}, Số tiền: ${feeAmount.toFixed(2)} tính theo 4% của số tiền gốc ${orgAmountCash}`);
        
        // Thêm giao dịch trực tiếp vào bảng
        const newRow = document.createElement('tr');
        newRow.id = `row-${transactionId.replace('T', '')}`;
        newRow.innerHTML = `
          <td>${transactionId}</td>
          <td>${originalTransactionId}</td>
          <td>${transactionType}</td>
          <td>${statusPaidCash}</td>
          <td>${amount}</td>
          <td>${transactionType === 'sale' || transactionType === 'cash' ? 0 : ''}</td>
          <td>${day}</td>
          <td>-</td>
          <td>-</td>
          <td>${day}</td>
          <td>-</td>
          <td>-</td>
          <td>
            ${
              transactionType === 'sale' && status === 'ssasa'
                ? `
                  <button class="edit-btn" onclick="voidTransaction('${transactionId}')">Void</button>
                  <button class="edit-btn" onclick="refundTransaction('${transactionId}')">Refund</button>
                `
                : ''
            }
          </td>
        `;
        tableBody.appendChild(newRow);
      

      // Thêm delimiter vào cuối bảng
      // const delimiterRow = document.createElement('tr');
      // delimiterRow.innerHTML = `
      //   <td colspan="11" style="background-color: #f0f0f0; text-align: center;">End cycle ${cycle + 1}</td>
      // `;
      // tableBody.appendChild(delimiterRow);

      ///Cập nhật ngày post
      // const tableRows = document.querySelectorAll('#transaction-table tbody tr'); // Lấy tất cả các hàng trong bảng

      // for (let i = lastIndex; i < tableRows.length; i++) { // Sửa điều kiện vòng lặp
      //   const row = tableRows[i];

      //   // Kiểm tra nếu hàng là delimiter hoặc không hợp lệ
      //   const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
      //   if (cells.length < 5) {
      //     continue; // Bỏ qua hàng không hợp lệ
      //   }
      //   //addLog(cells.length);

      //   const transactionType = row.children[2].textContent.trim(); // Loại giao dịch
      //   const status = row.children[3].textContent.trim(); // Trạng thái
      //   const day = row.children[6].textContent.trim(); // Ngày (cột thứ 7)
      //   const dayPostCell = row.children[9]; // Cột Ngày Post (cột thứ 10)

      //   // Chỉ xử lý giao dịch sale hoặc cash có trạng thái new
      //   if (status === 'new') 
      //   {
      //     if (transactionType === 'cash') {
      //       // Đối với giao dịch cash, Ngày Post bằng đúng ngày giao dịch
      //       dayPostCell.textContent = day;

      //       // Tìm giao dịch fee liên quan và cập nhật ngày post
      //       const feeTransactionId = `F${row.children[0].textContent.trim()}`; // ID giao dịch fee liên quan
      //       const feeRow = document.querySelector(`#row-${feeTransactionId}`);
      //       if (feeRow) {
      //         const feeDayPostCell = feeRow.children[9]; // Cột Ngày Post của fee
      //         feeDayPostCell.textContent = day; // Ngày Post của fee bằng ngày giao dịch cash
      //       }
      //     }
      //   }
      // }
      //
  
      // Cập nhật transactionIdCounter và dayCounter
      transactionIdCounter += 1;
      dayCounter += 1;
      addLineInLog();

      //alert(`${totalTransactions} giao dịch ngẫu nhiên đã được tạo!`);

      // Disable nút sau khi tạo giao dịch
      // const createButton = document.getElementById('create-sample-btn');
      // createButton.disabled = true;
      // createButton.style.opacity = 0.5; // Thêm hiệu ứng mờ
      // createButton.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
    }
    function createRandomTransactionPayment(amountPayment) 
    {
      //let maxTransactions = 20;
      const tableBody = document.querySelector('#transaction-table tbody');
      //const totalTransactions = Math.floor(Math.random() * maxTransactions) + 2; // Số ngẫu nhiên từ 1 đến maxTransactions
      let transactions = []; // Lưu trữ các giao dịch sale và cash để làm ID gốc cho void
      const maxPostDay = cycle === 0 ? 25 : (cycle * 25) + 25; // Kiểm tra giá trị của cycle
      buttonClickedCnt++;
      if(buttonClickedCnt > 25){
        buttonClickedCnt = 1; // Reset nếu vượt quá 25 lần nhấn nút "Tạo Giao Dịch Mẫu"
      }
      let newRowCash = null; // Biến để lưu hàng giao dịch cash nếu có
      let newRowSale = null; // Biến để lưu hàng giao dịch cash nếu có
      let newRowCnt = 0;

      // Tạo giao dịch mẫu

        const transactionId = `T${dayCounter + 1}`;
        let day = '';
        //addLog(`dayCounter: ${dayCounter}, cycle: ${cycle}, buttonClickedCnt: ${buttonClickedCnt}, maxPostDay: ${maxPostDay}`);

        // if(cycle === 0)
        // {
        //   if((dayCounter) < maxPostDay - 1)
        //   {
        //     day = `T + ${dayCounter  + (cycle*25)}`;
        //   }
        //   else
        //   {
        //     alert(`Không thể tạo giao dịch mới vì đã đạt đến giới hạn ngày post tối đa (T + ${maxPostDay}). Vui lòng tạo giao dịch mới sau khi reset.`);
        //     addDelimiterRow();
        //     return;
        //   }
        // }
        // else
        // {
          if((dayCounter) < maxPostDay - 1)
          {
            day = `T + ${dayCounter}`;
          }
          else
          {
            alert(`Không thể tạo giao dịch mới vì đã đạt đến giới hạn ngày post tối đa (T + ${maxPostDay}). Vui lòng tạo giao dịch mới sau khi reset.`);
            addDelimiterRow();
            return;
          }
        // }

        let transactionType, originalTransactionId, status, amount;
        dayVoided = '-';

        //const randomType = Math.random(); // Giá trị ngẫu nhiên để quyết định loại giao dịch

        // Tạo giao dịch payment

        transactionType = 'payment';
        originalTransactionId = '';
        status = 'completed';
        if(amountPayment > 0)
        {
            amount = amountPayment;
        }
        else
        {
            amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
        }
        //amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
        addLog(`Tạo giao dịch: ${transactionId}, Ngày: ${day}, Loại: ${transactionType}, Số tiền: ${amount}`);
        transactions.push({ id: transactionId, type: transactionType, status }); // Lưu giao dịch payment

        // Rà lại bảng và cập nhật giao dịch theo thứ tự cash, fee, sale
        const tableRows = document.querySelectorAll('#transaction-table tbody tr');
        let remainingPayment = amount; // Số tiền payment còn lại để xử lý

        // Xử lý giao dịch cash và fee
        for (let i = 0; i < tableRows.length; i++) 
        {
          const row = tableRows[i];
          // Kiểm tra nếu hàng là delimiter hoặc không hợp lệ
          const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
          if (cells.length < 5) {
            continue; // Bỏ qua hàng không hợp lệ
          }
          const transactionType = row.children[2].textContent.trim(); // Loại giao dịch
          const status = row.children[3].textContent.trim(); // Trạng thái
          const orgAmountCell = row.children[4]; // Cột Số Tiền gốc
          const updatedAmountCell = row.children[5]; // Cột Số Tiền Cập Nhật
          const paidDayCell = row.children[10]; // Cột Ngày Paid
          let orgAmount = parseFloat(orgAmountCell.textContent) || 0; // Số Tiền Gốc
          let updatedAmount = parseFloat(updatedAmountCell.textContent) || 0; // Số Tiền Cập Nhật

          // Chỉ xử lý các giao dịch fee và cash có trạng thái "new" hoặc "refunded" hoặc "partial"
          if ((transactionType === 'cash' || transactionType === 'fee') &&
              (status === 'new')) 
          {
            if (remainingPayment >= orgAmount) 
            {
                // Nếu số tiền payment đủ để thanh toán toàn bộ số tiền gốc
                //addLog(`Thanh toán toàn bộ số tiền gốc: ${orgAmount}`);
                remainingPayment -= orgAmount;
                updatedAmountCell.textContent = '0'; // Đặt số tiền cập nhật về 0
                row.children[3].textContent = 'paid'; // Cập nhật trạng thái thành "paid"
                paidDayCell.textContent = `T + ${dayCounter}`; // Cập nhật ngày paid

                addLog('Payment với ID : ' + transactionId + ' đã thanh toán toàn bộ số tiền gốc ' + orgAmount + ' cho giao dịch ' + transactionType + ' với ID: ' + row.children[0].textContent); // Log thông tin giao dịch đã thanh toán
                addLog(`Số tiền còn lại sau khi thanh toán: ${remainingPayment}`); // Log số tiền còn lại sau khi thanh toán
            } 
            else 
            {   
                // Nếu số tiền payment không đủ để thanh toán toàn bộ
                const remainingOrgAmount = orgAmount - remainingPayment; // Số tiền còn lại sau khi trừ payment

                // Cập nhật giao dịch hiện tại
                updatedAmountCell.textContent = remainingOrgAmount.toFixed(2); // Cập nhật số tiền còn lại
                paidDayCell.textContent = `T + ${dayCounter}`; // Cập nhật ngày paid
                row.children[3].textContent = 'paid'; // Cập nhật trạng thái thành "paid"
                newRowCnt++;
                const newTransactionId = `T${parseInt(transactionId.replace('T', '')) + newRowCnt}`; // Tính toán ID mới

                addLog('Payment với ID : ' + transactionId + ' đã thanh toán một phần ' + remainingPayment + ' cho giao dịch ' + transactionType + ' với ID: ' + row.children[0].textContent); // Log thông tin giao dịch đã thanh toán
                addLog(`Số tiền còn lại của giao dịch có ID ${row.children[0].textContent}: ${remainingOrgAmount}`); // Log số tiền còn lại sau khi thanh toán
                addLog(`Thêm 1 hàng mới cho giao dịch ${transactionType} với số tiền còn lại: ${remainingOrgAmount.toFixed(2)} với ID là ${newTransactionId}`); // Log thông tin giao dịch đã thanh toán
                remainingPayment = 0; // Đặt số tiền payment còn lại về 0

                // Thêm một hàng mới cho giao dịch cash với số tiền còn lại

                newRowCash = document.createElement('tr');
                newRowCash.innerHTML = ` 
                  <td>${newTransactionId}</td> <!-- ID mới -->
                  <td><span class="original-void">${row.children[0].textContent}</span></td> <!-- ID Giao Dịch Gốc -->
                  <td>cash</td> <!-- Loại Giao Dịch -->
                  <td>new</td> <!-- Trạng Thái -->
                  <td>${remainingOrgAmount.toFixed(2)}</td> <!-- Số Tiền Gốc -->
                  <td>-</td> <!-- Số Tiền Cập Nhật -->
                  <td>T + ${dayCounter}</td> <!-- Ngày -->
                  <td>-</td> <!-- Ngày Void -->
                  <td>-</td> <!-- Ngày Refund -->
                  <td>-</td> <!-- Ngày Post -->
                  <td>-</td> <!-- Ngày Paid -->
                  <td>-</td>
                  <td>-</td>
                  <td>-</td>
                  
                `;
                //tableBody.appendChild(newRowCash); // Thêm hàng mới vào bảng
            }

            // Nếu số tiền payment đã hết, thoát khỏi vòng lặp
            if (remainingPayment <= 0) {
              break;
            }
          }
        }
        // Nếu vẫn còn số tiền payment sau khi xử lý tất cả các giao dịch cash và fee xử lý tiếp các giao dịch sale
        if(remainingPayment > 0)
        {
          // Lặp qua các giao dịch sale
          for (let i = 0; i < tableRows.length; i++) 
          {
            const row = tableRows[i];
            const transactionType = row.children[2].textContent.trim(); // Loại giao dịch
            const status = row.children[3].textContent.trim(); // Trạng thái
            const orgAmountCell = row.children[4]; // Cột Số Tiền gốc
            const updatedAmountCell = row.children[5]; // Cột Số Tiền Cập Nhật
            const paidDayCell = row.children[10]; // Cột Ngày Paid
            let orgAmount = parseFloat(orgAmountCell.textContent) || 0; // Số Tiền Gốc
            let updatedAmount = parseFloat(updatedAmountCell.textContent) || 0; // Số Tiền Cập Nhật

            // Chỉ xử lý các giao dịch fee và cash có trạng thái "new" hoặc "refunded" hoặc "partial"
            if ((transactionType === 'sale') &&
                (status === 'new')) 
            {
              if (remainingPayment >= orgAmount) 
              {
                  // Nếu số tiền payment đủ để thanh toán toàn bộ số tiền gốc
                  //addLog(`Thanh toán toàn bộ số tiền gốc: ${orgAmount}`);
                  remainingPayment -= orgAmount;
                  updatedAmountCell.textContent = '0'; // Đặt số tiền cập nhật về 0
                  row.children[3].textContent = 'paid'; // Cập nhật trạng thái thành "paid"
                  paidDayCell.textContent = `T + ${dayCounter}`; // Cập nhật ngày paid

                  addLog('Payment với ID : ' + transactionId + ' đã thanh toán toàn bộ số tiền gốc ' + orgAmount + ' cho giao dịch ' + transactionType + ' với ID: ' + row.children[0].textContent); // Log thông tin giao dịch đã thanh toán
                  addLog(`Số tiền còn lại sau khi thanh toán: ${remainingPayment}`); // Log số tiền còn lại sau khi thanh toán
              } 
              else 
              {   
                
                  // Nếu số tiền payment không đủ để thanh toán toàn bộ
                  const remainingOrgAmount = orgAmount - remainingPayment; // Số tiền còn lại sau khi trừ payment
                  //remainingPayment = 0; // Đặt số tiền payment còn lại về 0

                  // Cập nhật giao dịch hiện tại
                  updatedAmountCell.textContent = remainingOrgAmount.toFixed(2); // Cập nhật số tiền còn lại
                  paidDayCell.textContent = `T + ${dayCounter}`; // Cập nhật ngày paid
                  row.children[3].textContent = 'paid'; // Cập nhật trạng thái thành "paid"
                  newRowCnt++;
                  const newTransactionId = `T${parseInt(transactionId.replace('T', '')) + newRowCnt}`; // Tính toán ID mới

                  addLog('Payment với ID : ' + transactionId + ' đã thanh toán một phần ' + remainingPayment + ' cho giao dịch ' + transactionType + ' với ID: ' + row.children[0].textContent); // Log thông tin giao dịch đã thanh toán
                  addLog(`Số tiền còn lại của giao dịch có ID ${row.children[0].textContent}: ${remainingOrgAmount}`); // Log số tiền còn lại sau khi thanh toán
                  addLog(`Thêm 1 hàng mới cho giao dịch ${transactionType} với số tiền còn lại: ${remainingOrgAmount.toFixed(2)} với ID là ${newTransactionId}`); // Log thông tin giao dịch đã thanh toán
                  remainingPayment = 0; // Đặt số tiền payment còn lại về 0

                  // Thêm một hàng mới cho giao dịch cash với số tiền còn lại
                  newRowSale = document.createElement('tr');
                  newRowSale.innerHTML = ` 
                    <td>${newTransactionId}</td> <!-- ID mới -->
                    <td><span class="original-void">${row.children[0].textContent}</span></td> <!-- ID Giao Dịch Gốc -->
                    <td>sale</td> <!-- Loại Giao Dịch -->
                    <td>new</td> <!-- Trạng Thái -->
                    <td>${remainingOrgAmount.toFixed(2)}</td> <!-- Số Tiền Gốc -->
                    <td>-</td> <!-- Số Tiền Cập Nhật -->
                    <td>T + ${dayCounter}</td> <!-- Ngày -->
                    <td>-</td> <!-- Ngày Void -->
                    <td>-</td> <!-- Ngày Refund -->
                    <td>-</td> <!-- Ngày Post -->
                    <td>-</td> <!-- Ngày Paid -->
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    
                  `;
                  //tableBody.appendChild(newRowCash); // Thêm hàng mới vào bảng
              }

              // Nếu số tiền payment đã hết, thoát khỏi vòng lặp
              if (remainingPayment <= 0) {
                break;
              }
            }
          }
        }

        // Nếu vẫn còn số tiền payment sau khi xử lý tất cả các giao dịch cash và fee và sale, thì hiển thị thông báo
        addLog(`Số tiền payment còn lại sau khi xử lý cash, fee và sale: ${remainingPayment}`);

        if (remainingPayment > 0) 
        {
            if(amountPaymentInCycle == 0) // Nếu chưa có payment nào trong chu kỳ này
            {
              //addLog('bằng 0');
              amountPaymentInCycle = remainingPayment; // Lưu số tiền payment còn lại trong biến toàn cục
            }
            else
            {
              //addLog('khác 0');
              amountPaymentInCycle += remainingPayment; // Lưu số tiền payment còn lại trong biến toàn cục
            }
            
            // Hiển thị số tiền payment còn lại trong label
            const paymentLabel = document.getElementById('payment-remaining-label');
            if (paymentLabel) {
              paymentLabel.textContent = `Số tiền thanh toán còn lại trong kỳ: ${amountPaymentInCycle.toFixed(2)}`;
            }
        }
        else 
        {
            amountPaymentInCycle = 0; // Đặt lại số tiền payment còn lại nếu đã thanh toán hết
            addLog(`Đã xử lý xong toàn bộ số tiền payment: ${amount}`);
            // Hiển thị số tiền payment còn lại trong label
            const paymentLabel = document.getElementById('payment-remaining-label');
            if (paymentLabel) {
              paymentLabel.textContent = `Số tiền thanh toán còn lại trong kỳ: ${amountPaymentInCycle.toFixed(2)}`;
            }
        }
        

        // Thêm giao dịch payment vào bảng
        const newRow = document.createElement('tr');
        newRow.id = `row-${transactionId}`;
        newRow.innerHTML = `
          <td>${transactionId}</td>
          <td>${originalTransactionId}</td>
          <td>payment</td>
          <td>${status}</td>
          <td>${amount}</td>
          <td>-</td>
          <td>${`T + ${dayCounter}`}</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
        `;
        tableBody.appendChild(newRow);

        if(newRowCash !== null) 
          tableBody.appendChild(newRowCash); // Thêm hàng mới vào bảng
      
        if(newRowSale !== null) 
          tableBody.appendChild(newRowSale); // Thêm hàng mới vào bảng
        
        // // Thêm giao dịch trực tiếp vào bảng
        // const newRow = document.createElement('tr');
        // newRow.id = `row-${transactionId.replace('T', '')}`;
        // newRow.innerHTML = `
        //   <td>${transactionId}</td>
        //   <td>${originalTransactionId}</td>
        //   <td>${transactionType}</td>
        //   <td>${status}</td>
        //   <td>${amount}</td>
        //   <td>${transactionType === 'sale' || transactionType === 'cash' ? 0 : ''}</td>
        //   <td>${day}</td>
        //   <td>${dayVoided}</td>
        //   <td>-</td>
        //   <td>-</td>
        //   <td>-</td>
        //   <td>
        //     ${
        //       transactionType === 'sale' && status === 'new'
        //         ? `
        //           <button class="edit-btn" onclick="voidTransaction('${transactionId}')">Void</button>
        //           <button class="edit-btn" onclick="refundTransaction('${transactionId}')">Refund</button>
        //         `
        //         : ''
        //     }
        //   </td>
        // `;
        // tableBody.appendChild(newRow);
      

      ///Cập nhật ngày post
      const tableRows1 = document.querySelectorAll('#transaction-table tbody tr'); // Lấy tất cả các hàng trong bảng

      for (let i = lastIndex; i < tableRows1.length; i++) { // Sửa điều kiện vòng lặp
        const row = tableRows1[i];

        // Kiểm tra nếu hàng là delimiter hoặc không hợp lệ
        const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
        if (cells.length < 5) {
          continue; // Bỏ qua hàng không hợp lệ
        }
        //addLog(cells.length);

        const transactionType = row.children[2].textContent.trim(); // Loại giao dịch
        const status = row.children[3].textContent.trim(); // Trạng thái
        const day = row.children[6].textContent.trim(); // Ngày (cột thứ 7)
        const dayPostCell = row.children[9]; // Cột Ngày Post (cột thứ 10)

        // Chỉ xử lý giao dịch sale hoặc cash có trạng thái new
        if (status === 'new' || status === 'completed') 
        {
          if (transactionType === 'sale') {
            // Tạo giá trị Ngày Post ngẫu nhiên, lớn hơn ngày hiện tại và nhỏ hơn T + 24
            const currentDay = parseInt(day.replace('T + ', '')) || 0; // Lấy giá trị số từ ngày
            //const postDay = Math.floor(Math.random() * (maxPostDay - currentDay)) + currentDay + 1; // Ngày Post ngẫu nhiên
            postDay = currentDay + 1; // Ngày Post là 1 ngày sau ngày giao dịch

            // Cập nhật cột Ngày Post
            dayPostCell.textContent = `T + ${postDay}`;
          } else if (transactionType === 'cash') {
            // Đối với giao dịch cash, Ngày Post bằng đúng ngày giao dịch
            dayPostCell.textContent = day;

            // Tìm giao dịch fee liên quan và cập nhật ngày post
            const feeTransactionId = `F${row.children[0].textContent.trim()}`; // ID giao dịch fee liên quan
            const feeRow = document.querySelector(`#row-${feeTransactionId}`);
            if (feeRow) {
              const feeDayPostCell = feeRow.children[9]; // Cột Ngày Post của fee
              feeDayPostCell.textContent = day; // Ngày Post của fee bằng ngày giao dịch cash
            }
          }
          else if (transactionType === 'payment') {
            // Đối với giao dịch payment, Ngày Post là 1 ngày sau ngày giao dịch
            const currentDay = parseInt(day.replace('T + ', '')) || 0; // Lấy giá trị số từ ngày
            const postDay = currentDay + 1; // Ngày Post là 1 ngày sau ngày giao dịch

            // Cập nhật cột Ngày Post
            dayPostCell.textContent = `T + ${postDay}`;
          }
        }
      }
      //
  
      // Cập nhật transactionIdCounter và dayCounter
      transactionIdCounter += 1;
      dayCounter += 1;
      addLineInLog();
    }
    
    function createTransactionPaymentWhenCalStatement(amountPayment) 
    {
      //let maxTransactions = 20;
      const tableBody = document.querySelector('#transaction-table tbody');
      //const totalTransactions = Math.floor(Math.random() * maxTransactions) + 2; // Số ngẫu nhiên từ 1 đến maxTransactions
      let transactions = []; // Lưu trữ các giao dịch sale và cash để làm ID gốc cho void
      const maxPostDay = cycle === 0 ? 25 : (cycle * 25) + 25; // Kiểm tra giá trị của cycle
      buttonClickedCnt++;
      if(buttonClickedCnt > 25){
        buttonClickedCnt = 1; // Reset nếu vượt quá 25 lần nhấn nút "Tạo Giao Dịch Mẫu"
      }
      let newRowCash = null; // Biến để lưu hàng giao dịch cash nếu có
      let newRowSale = null; // Biến để lưu hàng giao dịch cash nếu có
      let newRowCnt = 0;

      // Tạo giao dịch mẫu

      const transactionId = `T${dayCounter + 1}`;
      let day = '';
      //addLog(`dayCounter: ${dayCounter}, cycle: ${cycle}, buttonClickedCnt: ${buttonClickedCnt}, maxPostDay: ${maxPostDay}`);

      if((dayCounter) < maxPostDay - 1)
      {
        day = `T + ${dayCounter}`;
      }
      else
      {
          alert(`Không thể tạo giao dịch mới vì đã đạt đến giới hạn ngày post tối đa (T + ${maxPostDay}). Vui lòng tạo giao dịch mới sau khi reset.`);
          addDelimiterRow();
          return;
      }

      let transactionType, originalTransactionId, status, amount;
      dayVoided = '-';

      //const randomType = Math.random(); // Giá trị ngẫu nhiên để quyết định loại giao dịch

      // Tạo giao dịch payment

      transactionType = 'payment';
      originalTransactionId = '';
      status = 'completed';
      if(amountPayment > 0)
      {
          amount = amountPayment;
      }
      else
      {
          amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
      }
      //amount = Math.floor(Math.random() * 10 + 1) * 1000; // Số tiền ngẫu nhiên là bội số của 1000
      addLog(`Tạo giao dịch: ${transactionId}, Ngày: ${day}, Loại: ${transactionType}, Số tiền: ${amount}`);
      transactions.push({ id: transactionId, type: transactionType, status }); // Lưu giao dịch payment

      // Rà lại bảng và cập nhật giao dịch theo thứ tự cash, fee, sale
      const tableRows = document.querySelectorAll('#transaction-table tbody tr');
      let remainingPayment = amount; // Số tiền payment còn lại để xử lý

      // Xử lý giao dịch cash và fee
      for (let i = 0; i < tableRows.length; i++) 
      {
        const row = tableRows[i];
        // Kiểm tra nếu hàng là delimiter hoặc không hợp lệ
        const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
        if (cells.length < 5) {
          continue; // Bỏ qua hàng không hợp lệ
        }
        const transactionType = row.children[2].textContent.trim(); // Loại giao dịch
        const status = row.children[3].textContent.trim(); // Trạng thái
        const orgAmountCell = row.children[4]; // Cột Số Tiền gốc
        const updatedAmountCell = row.children[5]; // Cột Số Tiền Cập Nhật
        const paidDayCell = row.children[10]; // Cột Ngày Paid
        let orgAmount = parseFloat(orgAmountCell.textContent) || 0; // Số Tiền Gốc
        let updatedAmount = parseFloat(updatedAmountCell.textContent) || 0; // Số Tiền Cập Nhật

        // Chỉ xử lý các giao dịch fee và cash có trạng thái "new" hoặc "refunded" hoặc "partial"
        if ((transactionType === 'cash' || transactionType === 'fee') &&
            (status === 'new')) 
        {
          if (remainingPayment >= orgAmount) 
          {
              // Nếu số tiền payment đủ để thanh toán toàn bộ số tiền gốc
              //addLog(`Thanh toán toàn bộ số tiền gốc: ${orgAmount}`);
              remainingPayment -= orgAmount;
              updatedAmountCell.textContent = '0'; // Đặt số tiền cập nhật về 0
              row.children[3].textContent = 'paid'; // Cập nhật trạng thái thành "paid"
              paidDayCell.textContent = `T + ${dayCounter}`; // Cập nhật ngày paid

              addLog('Payment với ID : ' + transactionId + ' đã thanh toán toàn bộ số tiền gốc ' + orgAmount + ' cho giao dịch ' + transactionType + ' với ID: ' + row.children[0].textContent); // Log thông tin giao dịch đã thanh toán
              addLog(`Số tiền còn lại sau khi thanh toán: ${remainingPayment}`); // Log số tiền còn lại sau khi thanh toán
          } 
          else 
          {   
              // Nếu số tiền payment không đủ để thanh toán toàn bộ
              const remainingOrgAmount = orgAmount - remainingPayment; // Số tiền còn lại sau khi trừ payment
              const dateOrg = row.children[9].textContent; // Ngày gốc post của giao dịch

              // Cập nhật giao dịch hiện tại
              updatedAmountCell.textContent = remainingOrgAmount.toFixed(2); // Cập nhật số tiền còn lại
              paidDayCell.textContent = `T + ${dayCounter}`; // Cập nhật ngày paid
              row.children[3].textContent = 'paid'; // Cập nhật trạng thái thành "paid"
              newRowCnt++;
              const newTransactionId = `T${parseInt(transactionId.replace('T', '')) + newRowCnt}`; // Tính toán ID mới

              addLog('Payment với ID : ' + transactionId + ' đã thanh toán một phần ' + remainingPayment + ' cho giao dịch ' + transactionType + ' với ID: ' + row.children[0].textContent); // Log thông tin giao dịch đã thanh toán
              addLog(`Số tiền còn lại của giao dịch có ID ${row.children[0].textContent}: ${remainingOrgAmount}`); // Log số tiền còn lại sau khi thanh toán
              addLog(`Thêm 1 hàng mới cho giao dịch ${transactionType} với số tiền còn lại: ${remainingOrgAmount.toFixed(2)} với ID là ${newTransactionId}`); // Log thông tin giao dịch đã thanh toán
              remainingPayment = 0; // Đặt số tiền payment còn lại về 0

              // Thêm một hàng mới cho giao dịch cash với số tiền còn lại

              newRowCash = document.createElement('tr');
              newRowCash.innerHTML = ` 
                <td>${newTransactionId}</td> <!-- ID mới -->
                <td><span class="original-void">${row.children[0].textContent}</span></td> <!-- ID Giao Dịch Gốc -->
                <td>cash</td> <!-- Loại Giao Dịch -->
                <td>new</td> <!-- Trạng Thái -->
                <td>${remainingOrgAmount.toFixed(2)}</td> <!-- Số Tiền Gốc -->
                <td>-</td> <!-- Số Tiền Cập Nhật -->
                <td>${dateOrg}</td> <!-- Ngày -->
                <td>-</td> <!-- Ngày Void -->
                <td>-</td> <!-- Ngày Refund -->
                <td>${dateOrg}</td> <!-- Ngày Post -->
                <td>-</td> <!-- Ngày Paid -->
                <td>-</td>
                <td>-</td>
                <td>-</td>
                
              `;
              //tableBody.appendChild(newRowCash); // Thêm hàng mới vào bảng
          }

          // Nếu số tiền payment đã hết, thoát khỏi vòng lặp
          if (remainingPayment <= 0) {
            break;
          }
        }
      }
        // Nếu vẫn còn số tiền payment sau khi xử lý tất cả các giao dịch cash và fee xử lý tiếp các giao dịch sale
        if(remainingPayment > 0)
        {
          // Lặp qua các giao dịch sale
          for (let i = 0; i < tableRows.length; i++) 
          {
            const row = tableRows[i];
            // Kiểm tra nếu hàng là delimiter hoặc không hợp lệ
            const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
            if (cells.length < 5) {
              continue; // Bỏ qua hàng không hợp lệ
            }
            const transactionType = row.children[2].textContent.trim(); // Loại giao dịch
            const status = row.children[3].textContent.trim(); // Trạng thái
            const orgAmountCell = row.children[4]; // Cột Số Tiền gốc
            const updatedAmountCell = row.children[5]; // Cột Số Tiền Cập Nhật
            const paidDayCell = row.children[10]; // Cột Ngày Paid
            let orgAmount = parseFloat(orgAmountCell.textContent) || 0; // Số Tiền Gốc
            let updatedAmount = parseFloat(updatedAmountCell.textContent) || 0; // Số Tiền Cập Nhật

            // Chỉ xử lý các giao dịch fee và cash có trạng thái "new" hoặc "refunded" hoặc "partial"
            if ((transactionType === 'sale') &&
                (status === 'new')) 
            {
              if (remainingPayment >= orgAmount) 
              {
                  // Nếu số tiền payment đủ để thanh toán toàn bộ số tiền gốc
                  //addLog(`Thanh toán toàn bộ số tiền gốc: ${orgAmount}`);
                  remainingPayment -= orgAmount;
                  updatedAmountCell.textContent = '0'; // Đặt số tiền cập nhật về 0
                  row.children[3].textContent = 'paid'; // Cập nhật trạng thái thành "paid"
                  paidDayCell.textContent = `T + ${dayCounter}`; // Cập nhật ngày paid

                  addLog('Payment với ID : ' + transactionId + ' đã thanh toán toàn bộ số tiền gốc ' + orgAmount + ' cho giao dịch ' + transactionType + ' với ID: ' + row.children[0].textContent); // Log thông tin giao dịch đã thanh toán
                  addLog(`Số tiền còn lại sau khi thanh toán: ${remainingPayment}`); // Log số tiền còn lại sau khi thanh toán
              } 
              else 
              {   
                
                  // Nếu số tiền payment không đủ để thanh toán toàn bộ
                  const remainingOrgAmount = orgAmount - remainingPayment; // Số tiền còn lại sau khi trừ payment
                  //remainingPayment = 0; // Đặt số tiền payment còn lại về 0
                  const dateOrg = row.children[9].textContent; // Ngày gốc post của giao dịch
                  // Cập nhật giao dịch hiện tại
                  updatedAmountCell.textContent = remainingOrgAmount.toFixed(2); // Cập nhật số tiền còn lại
                  paidDayCell.textContent = `T + ${dayCounter}`; // Cập nhật ngày paid
                  row.children[3].textContent = 'paid'; // Cập nhật trạng thái thành "paid"
                  newRowCnt++;
                  const newTransactionId = `T${parseInt(transactionId.replace('T', '')) + newRowCnt}`; // Tính toán ID mới

                  addLog('Payment với ID : ' + transactionId + ' đã thanh toán một phần ' + remainingPayment + ' cho giao dịch ' + transactionType + ' với ID: ' + row.children[0].textContent); // Log thông tin giao dịch đã thanh toán
                  addLog(`Số tiền còn lại của giao dịch có ID ${row.children[0].textContent}: ${remainingOrgAmount}`); // Log số tiền còn lại sau khi thanh toán
                  addLog(`Thêm 1 hàng mới cho giao dịch ${transactionType} với số tiền còn lại: ${remainingOrgAmount.toFixed(2)} với ID là ${newTransactionId}`); // Log thông tin giao dịch đã thanh toán
                  remainingPayment = 0; // Đặt số tiền payment còn lại về 0

                  // Thêm một hàng mới cho giao dịch cash với số tiền còn lại
                  newRowSale = document.createElement('tr');
                  newRowSale.innerHTML = ` 
                    <td>${newTransactionId}</td> <!-- ID mới -->
                    <td><span class="original-void">${row.children[0].textContent}</span></td> <!-- ID Giao Dịch Gốc -->
                    <td>sale</td> <!-- Loại Giao Dịch -->
                    <td>new</td> <!-- Trạng Thái -->
                    <td>${remainingOrgAmount.toFixed(2)}</td> <!-- Số Tiền Gốc -->
                    <td>-</td> <!-- Số Tiền Cập Nhật -->
                    <td>${dateOrg}</td> <!-- Ngày -->
                    <td>-</td> <!-- Ngày Void -->
                    <td>-</td> <!-- Ngày Refund -->
                    <td>${dateOrg}</td> <!-- Ngày Post -->
                    <td>-</td> <!-- Ngày Paid -->
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    
                  `;
                  //tableBody.appendChild(newRowCash); // Thêm hàng mới vào bảng
              }

              // Nếu số tiền payment đã hết, thoát khỏi vòng lặp
              if (remainingPayment <= 0) {
                break;
              }
            }
          }
        }

        // Nếu vẫn còn số tiền payment sau khi xử lý tất cả các giao dịch cash và fee và sale, thì hiển thị thông báo
        addLog(`Số tiền payment còn lại sau khi xử lý cash, fee và sale: ${remainingPayment}`);

        if (remainingPayment > 0) 
        {
            if(amountPaymentInCycle == 0) // Nếu chưa có payment nào trong chu kỳ này
            {
              //addLog('bằng 0');
              amountPaymentInCycle = remainingPayment; // Lưu số tiền payment còn lại trong biến toàn cục
            }
            else
            {
              //addLog('khác 0');
              amountPaymentInCycle += remainingPayment; // Lưu số tiền payment còn lại trong biến toàn cục
            }
            
            // Hiển thị số tiền payment còn lại trong label
            const paymentLabel = document.getElementById('payment-remaining-label');
            if (paymentLabel) {
              paymentLabel.textContent = `Số tiền thanh toán còn lại trong kỳ: ${amountPaymentInCycle.toFixed(2)}`;
            }
        }
        else 
        {
            amountPaymentInCycle = 0; // Đặt lại số tiền payment còn lại nếu đã thanh toán hết
            addLog(`Đã xử lý xong toàn bộ số tiền payment: ${amount}`);
            // Hiển thị số tiền payment còn lại trong label
            const paymentLabel = document.getElementById('payment-remaining-label');
            if (paymentLabel) {
              paymentLabel.textContent = `Số tiền thanh toán còn lại trong kỳ: ${amountPaymentInCycle.toFixed(2)}`;
            }
        }
        

        // Thêm giao dịch payment vào bảng
        const newRow = document.createElement('tr');
        newRow.id = `row-${transactionId}`;
        newRow.innerHTML = `
          <td>${transactionId}</td>
          <td>${originalTransactionId}</td>
          <td>payment</td>
          <td>${status}</td>
          <td>${amount}</td>
          <td>-</td>
          <td>${`T + ${dayCounter}`}</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
        `;
        tableBody.appendChild(newRow);

        if(newRowCash !== null) 
          tableBody.appendChild(newRowCash); // Thêm hàng mới vào bảng
      
        if(newRowSale !== null) 
          tableBody.appendChild(newRowSale); // Thêm hàng mới vào bảng
        
      ///Cập nhật ngày post
      // const tableRows1 = document.querySelectorAll('#transaction-table tbody tr'); // Lấy tất cả các hàng trong bảng

      // for (let i = lastIndex; i < tableRows1.length; i++) { // Sửa điều kiện vòng lặp
      //   const row = tableRows1[i];

      //   // Kiểm tra nếu hàng là delimiter hoặc không hợp lệ
      //   const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
      //   if (cells.length < 5) {
      //     continue; // Bỏ qua hàng không hợp lệ
      //   }
      //   //addLog(cells.length);

      //   const transactionType = row.children[2].textContent.trim(); // Loại giao dịch
      //   const status = row.children[3].textContent.trim(); // Trạng thái
      //   const day = row.children[6].textContent.trim(); // Ngày (cột thứ 7)
      //   const dayPostCell = row.children[9]; // Cột Ngày Post (cột thứ 10)

      //   // Chỉ xử lý giao dịch sale hoặc cash có trạng thái new
      //   if (status === 'new' || status === 'completed') 
      //   {
      //     if (transactionType === 'sale') {
      //       // Tạo giá trị Ngày Post ngẫu nhiên, lớn hơn ngày hiện tại và nhỏ hơn T + 24
      //       const currentDay = parseInt(day.replace('T + ', '')) || 0; // Lấy giá trị số từ ngày
      //       //const postDay = Math.floor(Math.random() * (maxPostDay - currentDay)) + currentDay + 1; // Ngày Post ngẫu nhiên
      //       postDay = currentDay + 1; // Ngày Post là 1 ngày sau ngày giao dịch

      //       // Cập nhật cột Ngày Post
      //       dayPostCell.textContent = `T + ${postDay}`;
      //     } else if (transactionType === 'cash') {
      //       // Đối với giao dịch cash, Ngày Post bằng đúng ngày giao dịch
      //       dayPostCell.textContent = day;

      //       // Tìm giao dịch fee liên quan và cập nhật ngày post
      //       const feeTransactionId = `F${row.children[0].textContent.trim()}`; // ID giao dịch fee liên quan
      //       const feeRow = document.querySelector(`#row-${feeTransactionId}`);
      //       if (feeRow) {
      //         const feeDayPostCell = feeRow.children[9]; // Cột Ngày Post của fee
      //         feeDayPostCell.textContent = day; // Ngày Post của fee bằng ngày giao dịch cash
      //       }
      //     }
      //     else if (transactionType === 'payment') {
      //       // Đối với giao dịch payment, Ngày Post là 1 ngày sau ngày giao dịch
      //       const currentDay = parseInt(day.replace('T + ', '')) || 0; // Lấy giá trị số từ ngày
      //       const postDay = currentDay + 1; // Ngày Post là 1 ngày sau ngày giao dịch

      //       // Cập nhật cột Ngày Post
      //       dayPostCell.textContent = `T + ${postDay}`;
      //     }
      //   }
      // }
      //
  
      // Cập nhật transactionIdCounter và dayCounter
      transactionIdCounter += 1;
      dayCounter += 1;
      addLineInLog();
    }

    function createRandomTransactionVoid() {
      //let maxTransactions = 20;
      const tableBody = document.querySelector('#transaction-table tbody');
      //const totalTransactions = Math.floor(Math.random() * maxTransactions) + 2; // Số ngẫu nhiên từ 1 đến maxTransactions
      let transactions = []; // Lưu trữ các giao dịch sale và cash để làm ID gốc cho void
      const maxPostDay = cycle === 0 ? 25 : (cycle * 25) + 25; // Kiểm tra giá trị của cycle
      buttonClickedCnt++;
      if(buttonClickedCnt > 25){
        buttonClickedCnt = 1; // Reset nếu vượt quá 25 lần nhấn nút "Tạo Giao Dịch Mẫu"
      }

      // Tạo giao dịch mẫu

        const transactionId = `T${dayCounter + 1}`;
        let day = '';
        addLog(`dayCounter: ${dayCounter}, cycle: ${cycle}, buttonClickedCnt: ${buttonClickedCnt}, maxPostDay: ${maxPostDay}`);

        if(cycle === 0)
        {
          if((dayCounter) < maxPostDay - 1)
          {
            day = `T + ${dayCounter  + (cycle*25)}`;
          }
          else
          {
            alert(`Không thể tạo giao dịch mới vì đã đạt đến giới hạn ngày post tối đa (T + ${maxPostDay}). Vui lòng tạo giao dịch mới sau khi reset.`);
            addDelimiterRow();
            return;
          }
        }
        else
        {
          if((dayCounter) < maxPostDay - 1)
          {
            day = `T + ${dayCounter}`;
          }
          else
          {
            alert(`Không thể tạo giao dịch mới vì đã đạt đến giới hạn ngày post tối đa (T + ${maxPostDay}). Vui lòng tạo giao dịch mới sau khi reset.`);
            addDelimiterRow();
            return;
          }
        }
        
        let transactionType, originalTransactionId, status, amount;
        dayVoided = '-';

        const randomType = Math.random(); // Giá trị ngẫu nhiên để quyết định loại giao dịch
        const tableRows = document.querySelectorAll('#transaction-table tbody tr'); // Lấy tất cả các hàng trong bảng
        transactions = getTransactionsFromTable();
        // Tạo giao dịch void
       //const validTransactions = transactions.filter(tx => tx.status === 'new'); // Chỉ lấy các giao dịch sale hoặc cash có trạng thái new

        const validTransactions = transactions.filter(tx => 
          tx.status === 'new' && (!tx.originalTransactionId || tx.originalTransactionId.trim() === '')
        ); // Chỉ lấy các giao dịch sale hoặc cash có trạng thái new và không có giá trị trong cột ID G.D Gốc

        addLog(`validTransactions.length: ${validTransactions.length}`);
        if (validTransactions.length === 0) {
          return; // Bỏ qua nếu không có giao dịch hợp lệ
        }
        //liệt kê hết các ID hợp lệ
        validTransactions.forEach(tx => {
          addLog(`ID hợp lệ: ${tx.id}`);
        });
        const selectedTransaction = validTransactions[Math.floor(Math.random() * validTransactions.length)]; // Chọn ngẫu nhiên một giao dịch hợp lệ
        addLog(`selectedTransaction.id: ${selectedTransaction.id}`);
        addLog(`transactionId: ${transactionId}`);

        transactionType = 'void';
        originalTransactionId = `<span class="original-void">${selectedTransaction.id}</span>`; // Thêm class màu đỏ
        status = 'voided';
        amount = 0; // Void không có số tiền

        // Cập nhật trạng thái của giao dịch gốc
        const currentRow = document.querySelector(`#row-${selectedTransaction.id.replace('T', '')}`);
        if (currentRow) 
        {
          const transactionDay = parseInt(currentRow.children[6].textContent.replace('T + ', '')) || 0; // Lấy ngày giao dịch từ cột thứ 7
          const voidDay = Math.min(transactionDay + 1, maxPostDay); // Ngày void không được quá 1 ngày so với ngày giao dịch và nhỏ hơn hoặc bằng T + 24

          currentRow.children[3].textContent = "voided"; // Cập nhật trạng thái thành voided
          currentRow.children[7].textContent = `T + ${voidDay}`; // Cập nhật ngày voided
          const buttons = currentRow.querySelectorAll('button');
          buttons.forEach(button => {
            button.disabled = true;
            button.style.opacity = 0.5; // Thêm hiệu ứng mờ
            button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
          });

          // Nếu giao dịch gốc là cash, void luôn giao dịch fee liên quan
          if (selectedTransaction.type === 'cash') {
            const feeTransactionId = `F${selectedTransaction.id}`; // ID giao dịch fee liên quan
            const feeRow = document.querySelector(`#row-${feeTransactionId}`);
            if (feeRow) {
              feeRow.children[3].textContent = "voided"; // Cập nhật trạng thái thành voided
              feeRow.children[7].textContent = `T + ${voidDay}`; // Cập nhật ngày voided
              const feeButtons = feeRow.querySelectorAll('button');
              feeButtons.forEach(button => {
                button.disabled = true;
                button.style.opacity = 0.5; // Thêm hiệu ứng mờ
                button.style.cursor = 'not-allowed'; // Thay đổi con trỏ chuột
              });

              // Cập nhật trạng thái của giao dịch fee trong mảng transactions
              const feeTransactionIndex = transactions.findIndex(tx => tx.id === feeTransactionId);
              if (feeTransactionIndex !== -1) {
                transactions[feeTransactionIndex].status = 'voided'; // Cập nhật trạng thái thành voided
              }
            }
          }
        }

        // Cập nhật trạng thái của giao dịch gốc trong mảng transactions
        const transactionIndex = transactions.findIndex(tx => tx.id === selectedTransaction.id);
        if (transactionIndex !== -1) {
          transactions[transactionIndex].status = 'voided'; // Cập nhật trạng thái thành voided
        }
        
        
        // Thêm giao dịch trực tiếp vào bảng
        const newRow = document.createElement('tr');
        newRow.id = `row-${transactionId.replace('T', '')}`;
        newRow.innerHTML = `
          <td>${transactionId}</td>
          <td>${originalTransactionId}</td>
          <td>${transactionType}</td>
          <td>${status}</td>
          <td>${amount}</td>
          <td>${transactionType === 'sale' || transactionType === 'cash' ? 0 : ''}</td>
          <td>${day}</td>
          <td>${dayVoided}</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>
            ${
              transactionType === 'sale' && status === 'new'
                ? `
                  <button class="edit-btn" onclick="voidTransaction('${transactionId}')">Void</button>
                  <button class="edit-btn" onclick="refundTransaction('${transactionId}')">Refund</button>
                `
                : ''
            }
          </td>
        `;
        tableBody.appendChild(newRow);
    
      ///Cập nhật ngày post
      const tableRows1 = document.querySelectorAll('#transaction-table tbody tr'); // Lấy tất cả các hàng trong bảng

      for (let i = lastIndex; i < tableRows1.length; i++) { // Sửa điều kiện vòng lặp
        const row = tableRows1[i];

        // Kiểm tra nếu hàng là delimiter hoặc không hợp lệ
        const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
        if (cells.length < 5) {
          continue; // Bỏ qua hàng không hợp lệ
        }
        //addLog(cells.length);

        const transactionType = row.children[2].textContent.trim(); // Loại giao dịch
        const status = row.children[3].textContent.trim(); // Trạng thái
        const day = row.children[6].textContent.trim(); // Ngày (cột thứ 7)
        const dayPostCell = row.children[9]; // Cột Ngày Post (cột thứ 10)

        // Chỉ xử lý giao dịch sale hoặc cash có trạng thái new
        if (status === 'new' || status === 'completed') 
        {
          if (transactionType === 'sale') {
            // Tạo giá trị Ngày Post ngẫu nhiên, lớn hơn ngày hiện tại và nhỏ hơn T + 24
            const currentDay = parseInt(day.replace('T + ', '')) || 0; // Lấy giá trị số từ ngày
            const postDay = Math.floor(Math.random() * (maxPostDay - currentDay)) + currentDay + 1; // Ngày Post ngẫu nhiên

            // Cập nhật cột Ngày Post
            dayPostCell.textContent = `T + ${postDay}`;
          } else if (transactionType === 'cash') {
            // Đối với giao dịch cash, Ngày Post bằng đúng ngày giao dịch
            dayPostCell.textContent = day;

            // Tìm giao dịch fee liên quan và cập nhật ngày post
            const feeTransactionId = `F${row.children[0].textContent.trim()}`; // ID giao dịch fee liên quan
            const feeRow = document.querySelector(`#row-${feeTransactionId}`);
            if (feeRow) {
              const feeDayPostCell = feeRow.children[9]; // Cột Ngày Post của fee
              feeDayPostCell.textContent = day; // Ngày Post của fee bằng ngày giao dịch cash
            }
          }
          else if (transactionType === 'payment') {
            // Đối với giao dịch payment, Ngày Post là 1 ngày sau ngày giao dịch
            const currentDay = parseInt(day.replace('T + ', '')) || 0; // Lấy giá trị số từ ngày
            const postDay = currentDay + 1; // Ngày Post là 1 ngày sau ngày giao dịch

            // Cập nhật cột Ngày Post
            dayPostCell.textContent = `T + ${postDay}`;
          }
        }
      }
      //
  
      // Cập nhật transactionIdCounter và dayCounter
      transactionIdCounter += 1;
      dayCounter += 1;
      addLineInLog();

    }

    function addDelimiterRow() {
      const tableBody = document.querySelector('#transaction-table tbody');
      // Thêm delimiter vào cuối bảng
      const delimiterRow = document.createElement('tr');
      delimiterRow.innerHTML = `
          <td colspan="14" style="background-color: #f0f0f0; text-align: center; color: red;">End cycle ${cycle + 1}</td>
      `;
      tableBody.appendChild(delimiterRow);
    }

    let transactions = []; // Lưu trữ các giao dịch sale và cash để làm ID gốc cho void

    function getTransactionsFromTable() {
      const tableRows = document.querySelectorAll('#transaction-table tbody tr'); // Lấy tất cả các hàng trong bảng
      let transactions = []; // Khởi tạo mảng transactions

      tableRows.forEach(row => {
        const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
        if (cells.length < 5) {
          return; // Bỏ qua hàng không hợp lệ
        }

        const transaction = {
          id: cells[0].textContent.trim(), // ID giao dịch
          originalTransactionId: cells[1].textContent.trim(), // ID giao dịch gốc
          type: cells[2].textContent.trim(), // Loại giao dịch
          status: cells[3].textContent.trim(), // Trạng thái
          amount: parseFloat(cells[4].textContent.trim()) || 0, // Số tiền gốc
          updatedAmount: parseFloat(cells[5].textContent.trim()) || 0, // Số tiền cập nhật
          day: cells[6].textContent.trim(), // Ngày giao dịch
          dayVoided: cells[7].textContent.trim(), // Ngày void
          dayRefunded: cells[8].textContent.trim(), // Ngày refund
          dayPost: cells[9].textContent.trim(), // Ngày post
          dayPaid: cells[10].textContent.trim() // Ngày paid
        };

        transactions.push(transaction); // Thêm giao dịch vào mảng
      });

      return transactions; // Trả về mảng transactions
    }

    function updateLabelAmtPaymentInCycle() {
      // Hiển thị số tiền payment còn lại trong label
      const paymentLabel = document.getElementById('payment-remaining-label');
      if (paymentLabel) {
        paymentLabel.textContent = `Số tiền thanh toán còn lại trong kỳ: ${amountPaymentInCycle.toFixed(2)}`;
      }
    }

    function addLog(message) {
      console.log(message);
      const logContainer = document.getElementById('log-container');
      if (logContainer) 
      {
        const logEntry = document.createElement('div');
        logEntry.textContent = message;
        logEntry.style.marginBottom = '5px';
        logContainer.appendChild(logEntry);

        // Tự động cuộn xuống cuối log
        logContainer.scrollTop = logContainer.scrollHeight;
      }
    }

    function addLineInLog() {
      addLog('----------------------------------------');
    }

    function updateStatusStatement() 
    {
      // Lấy tất cả các hàng trong bảng
      const tableRows = document.querySelectorAll('#transaction-table tbody tr');

      // Duyệt qua từng hàng
      for (let i = 0; i < tableRows.length; i++) 
      {
        const row = tableRows[i];
        const cells = row.querySelectorAll('td'); // Lấy tất cả các ô trong hàng
        if (cells.length < 5) 
        {
            continue;
        }
        const statusCell = row.children[3]; // Cột Trạng Thái
        const payFullCell = row.children[10]; // Cột Ngày Paid
        const statementStatusCell = row.children[11]; // Cột T.T sao kê

        const status = statusCell.textContent.trim(); // Lấy giá trị trạng thái
        const payFull = payFullCell.textContent.trim(); // Lấy giá trị Ngày Paid

        // Kiểm tra điều kiện và cập nhật cột T.T sao kê
        if (status === 'new' && statementStatusCell.textContent == '-') 
        {
            if(payAction == 1) //payfull
            {
                statementStatusCell.textContent = 'Done'; // Cập nhật thành "done"
                statusCell.textContent = 'Paid'; // Cập nhật trạng thái thành "completed"
            } 
            else
            {
                statementStatusCell.textContent = 'Interest'; // Cập nhật thành "interest"
                //statusCell.textContent = 'Interest'; // Cập nhật trạng thái thành "interest"
            }
              
            // else if(payAction == 3) //pay greater than min
            //   statementStatusCell.textContent = 'Paygreater'; // Cập nhật thành "late"
            // else if(payAction == 4) //pay less than min
            //   statementStatusCell.textContent = 'Payless'; // Cập nhật thành "interest"
            // else if(payAction == 5) //no pay
            //   statementStatusCell.textContent = 'Nopay'; // Cập nhật thành "Nopay"
        } 
        else if(status === 'new' && statementStatusCell.textContent !== '-')
        {
            if(payAction == 1) //payfull
                statementStatusCell.textContent = 'Done'; // Cập nhật thành "done"
            else
                statementStatusCell.textContent = 'Interest'; // Cập nhật thành "interest"
        }
      }
    }
    /////////////

    document.getElementById('create-sample-btn').addEventListener('click', createRandomTransactions);
    document.getElementById('create-txn-sample-btn').addEventListener('click', createRandomTransaction);

    document.getElementById('create-txn-sale-sample-btn').addEventListener('click', createRandomTransactionSale);
    document.getElementById('create-txn-cash-sample-btn').addEventListener('click', createRandomTransactionCash);
    document.getElementById('create-txn-payment-sample-btn').addEventListener('click', function() {
      createRandomTransactionPayment(0); // Truyền giá trị 0 vào hàm
    });
    document.getElementById('create-txn-void-sample-btn').addEventListener('click', createRandomTransactionVoid);
    document.getElementById('add-Delimeter-btn').addEventListener('click', addDelimiterRow);
    document.getElementById('reset-log-btn').addEventListener('click', resetLog);

    document.getElementById('reset-sample-btn').addEventListener('click', resetTransactionTable);
    // Gắn sự kiện cho nút Reset Local Storage
    document.getElementById('reset-localstorage-btn').addEventListener('click', resetLocalStorage);
    document.getElementById('save-table-btn').addEventListener('click', saveTableToLocalStorage);
    document.getElementById('save-table-btn1').addEventListener('click', saveTableToFile);
    document.addEventListener('DOMContentLoaded', loadTableFromLocalStorage);
    document.getElementById('upload-file').addEventListener('change', loadTableFromFile);
    document.getElementById('cal-statement').addEventListener('click', calculateStatement);
    // Load navigation bar
    fetch('../partials/nav.html')
      .then(response => response.text())
      .then(data => document.getElementById('nav-placeholder').innerHTML = data);
  </script>
  <script src="../js/scripts.js"></script> <!-- Tải script chung -->
</body>
</html>